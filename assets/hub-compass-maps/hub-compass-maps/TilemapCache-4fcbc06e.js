import { gx as A, gy as s$1, aQ as a, g7 as m, O as j, gz as M, f as s$2, a0 as m$1, bJ as e$1, J as l, K as h, R as w$1, S as c, W as d, eV as e$2, gA as y$1, bI as a$1, di as t$1, fE as v, gB as l$1, a1 as e$3, a2 as y$2, a3 as a$2 } from './hub-compass-map-68308039.js';
import { E } from './ByteSizeUnit-f75ee973.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
function t(n,t=!1){return n<=A?t?new Array(n).fill(0):new Array(n):new Uint32Array(n)}function e(t){return (s$1(t)?t.length:t.byteLength/8)<=A?Array.from(t):new Uint32Array(t)}function y(r,n,t){return Array.isArray(r)?r.slice(n,n+t):r.subarray(n,n+t)}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
class r{constructor(t$1){this._validateJSON(t$1);const{location:i,data:e}=t$1;this.location=Object.freeze(a(i));const r=this.location.width,n=this.location.height;let s=!0,h=!0;const c=Math.ceil(r*n/32),m$1=t(c);let f=0;for(let a=0;a<e.length;a++){const t=a%32;e[a]?(h=!1,m$1[f]|=1<<t):s=!1,31===t&&++f;}h?(this._availability="unavailable",this.byteSize=40):s?(this._availability="available",this.byteSize=40):(this._availability=m$1,this.byteSize=40+m(m$1));}getAvailability(t,i){if("unavailable"===this._availability||"available"===this._availability)return this._availability;const e=(t-this.location.top)*this.location.width+(i-this.location.left),a=e%32,o=e>>5,l=this._availability;return o<0||o>l.length?"unknown":l[o]&1<<a?"available":"unavailable"}static fromDefinition(a,o){const l=a.service.request||j,{row:n,col:h,width:c,height:m}=a,f={query:{f:"json"}};return o=o?{...f,...o}:f,l(s(a),o).then((t=>t.data)).catch((t=>{if(t&&t.details&&422===t.details.httpStatus)return {location:{top:n,left:h,width:c,height:m},valid:!0,data:M(c*m,0)};throw t})).then((t=>{if(t.location&&(t.location.top!==n||t.location.left!==h||t.location.width!==c||t.location.height!==m))throw new s$2("tilemap:location-mismatch","Tilemap response for different location than requested",{response:t,definition:{top:n,left:h,width:c,height:m}});return r.fromJSON(t)}))}static fromJSON(t){return Object.freeze(new r(t))}_validateJSON(t){if(!t||!t.location)throw new s$2("tilemap:missing-location","Location missing from tilemap response");if(!1===t.valid)throw new s$2("tilemap:invalid","Tilemap response was marked as invalid");if(!t.data)throw new s$2("tilemap:missing-data","Data missing from tilemap response");if(!Array.isArray(t.data))throw new s$2("tilemap:data-mismatch","Data must be an array of numbers");if(t.data.length!==t.location.width*t.location.height)throw new s$2("tilemap:data-mismatch","Number of data items does not match width/height of tilemap")}}function n(t){return `${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`}function s(t){let i;if(t.service.tileServers?.length){const e=t.service.tileServers;i=`${e&&e.length?e[t.row%e.length]:t.service.url}/tilemap/${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`;}else i=`${t.service.url}/tilemap/${t.level}/${t.row}/${t.col}/${t.width}/${t.height}`;const e=t.service.query;return e&&(i=`${i}?${e}`),i}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
var w;let T=w=class extends m$1{constructor(e){super(e),this._pendingTilemapRequests={},this.request=j,this.size=32,this._prefetchingEnabled=!0;}initialize(){this._tilemapCache=new e$1(2*E.MEGABYTES),this.addHandles([l((()=>{const{layer:e}=this;return [e?.parsedUrl,e?.tileServers,e?.apiKey,e?.customParameters]}),(()=>this._initializeTilemapDefinition()),h)]);}get effectiveMinLOD(){return this.minLOD??this.layer.tileInfo.lods[0].level}get effectiveMaxLOD(){return this.maxLOD??this.layer.tileInfo.lods[this.layer.tileInfo.lods.length-1].level}fetchTilemap(e,t,i,r$1){if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return Promise.reject(new s$2("tilemap-cache:level-unavailable",`Level ${e} is unavailable in the service`));const l=this._tmpTilemapDefinition,o=this._tilemapFromCache(e,t,i,l);if(o)return Promise.resolve(o);const a=r$1&&r$1.signal;return r$1={...r$1,signal:null},new Promise(((e,t)=>{w$1(a,(()=>t(c())));const i=n(l);let s=this._pendingTilemapRequests[i];if(!s){s=r.fromDefinition(l,r$1).then((e=>(this._tilemapCache.put(i,e,e.byteSize),e)));const e=()=>delete this._pendingTilemapRequests[i];this._pendingTilemapRequests[i]=s,s.then(e,e);}s.then(e,t);}))}getAvailability(e,t,i){if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return "unavailable";const r=this._tilemapFromCache(e,t,i,this._tmpTilemapDefinition);return r?r.getAvailability(t,i):"unknown"}fetchAvailability(e,t,i,r$1){return !this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD?Promise.reject(new s$2("tile-map:tile-unavailable","Tile is not available",{level:e,row:t,col:i})):this.fetchTilemap(e,t,i,r$1).catch((e=>e)).then((r$1=>{if(r$1 instanceof r){const l=r$1.getAvailability(t,i);if("unavailable"===l)throw new s$2("tile-map:tile-unavailable","Tile is not available",{level:e,row:t,col:i});return l}if(d(r$1))throw r$1;return "unknown"}))}fetchAvailabilityUpsample(e,t,i,r,s){r.level=e,r.row=t,r.col=i;const l=this.layer.tileInfo;l.updateTileInfo(r);const o=this.fetchAvailability(e,t,i,s).catch((e=>{if(d(e))throw e;if(l.upsampleTile(r))return this.fetchAvailabilityUpsample(r.level,r.row,r.col,r,s);throw e}));return this._fetchAvailabilityUpsamplePrefetch(r.id,e,t,i,s,o),o}async _fetchAvailabilityUpsamplePrefetch(e,t,i,r,s,o){if(!this._prefetchingEnabled||null==e)return;const a=`prefetch-${e}`;if(this.hasHandles(a))return;const n=new AbortController;o.then((()=>n.abort()),(()=>n.abort()));let c=!1;const h=e$2((()=>{c||(c=!0,n.abort());}));if(this.addHandles(h,a),await y$1(10,n.signal).catch((()=>{})),c||(c=!0,this.removeHandles(a)),a$1(n))return;const m=new t$1(e,t,i,r),f={...s,signal:n.signal},v=this.layer.tileInfo;for(let l=0;w._prefetches.length<w._maxPrefetch&&v.upsampleTile(m);++l){const e=this.fetchAvailability(m.level,m.row,m.col,f);w._prefetches.push(e);const t=()=>{w._prefetches.removeUnordered(e);};e.then(t,t);}}_initializeTilemapDefinition(){if(!this.layer.parsedUrl)return;const{parsedUrl:e,apiKey:t,customParameters:i}=this.layer;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:e.path,query:v({...e.query,...i,token:t??e.query?.token}),tileServers:this.layer.tileServers,request:this.request},width:this.size,height:this.size,level:0,row:0,col:0};}_tilemapFromCache(e,t,i,r){r.level=e,r.row=t-t%this.size,r.col=i-i%this.size;const s=n(r);return this._tilemapCache.get(s)}get test(){const e=this;return {get prefetchingEnabled(){return e._prefetchingEnabled},set prefetchingEnabled(t){e._prefetchingEnabled=t;},hasTilemap:(t,i,r)=>!!e._tilemapFromCache(t,i,r,e._tmpTilemapDefinition)}}};T._maxPrefetch=4,T._prefetches=new l$1({initialSize:w._maxPrefetch}),e$3([y$2({constructOnly:!0})],T.prototype,"layer",void 0),e$3([y$2({constructOnly:!0})],T.prototype,"minLOD",void 0),e$3([y$2({constructOnly:!0})],T.prototype,"maxLOD",void 0),e$3([y$2({constructOnly:!0})],T.prototype,"request",void 0),e$3([y$2({constructOnly:!0})],T.prototype,"size",void 0),T=w=e$3([a$2("esri.layers.support.TilemapCache")],T);

export { T };

//# sourceMappingURL=TilemapCache-4fcbc06e.js.map