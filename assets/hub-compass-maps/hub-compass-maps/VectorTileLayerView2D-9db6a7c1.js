import { O as j, I as e$4, fH as kt, f4 as f$1, Q as m$2, aF as f$2, bC as e$5, W as d$1, d3 as j$1, bJ as e$6, f6 as l$6, t as t$6, g7 as m$3, c5 as r$5, M, w as h$2, v as f$3, m as e$8, g8 as r$7, _ as n$5, C, ap as i$6, eG as h$3, fk as j$2, cB as h$4, J as l$9, K as h$5, bO as a$3, g9 as s$4, H as l$a, bz as S, s as s$5, eH as y$1, aQ as a$4, a1 as e$9, a2 as y$2, a3 as a$5 } from './hub-compass-map-f4225e12.js';
import { E, I as I$1 } from './enums-64077e1c.js';
import { t as t$5 } from './Rect-b4ddc2bf.js';
import { G, D as D$1, F, O, I, R, C as C$1, E as E$1 } from './enums-f1bebe6f.js';
import { b as e$2, T } from './Texture-52798ec4.js';
import { n as n$3 } from './pbf-2ae522ce.js';
import { e as e$3 } from './rasterizingUtils-7c9a99ce.js';
import { c as c$2, u as u$2 } from './VertexArrayObject-2a8cdbad.js';
import { e as e$7, t as t$7, c as c$3 } from './config-78edfbcd.js';
import { r as r$4 } from './TiledDisplayObject-60abc381.js';
import { r as r$6, l as l$7, n as n$4, i as i$4, a as a$2 } from './StyleDefinition-4cf61a7b.js';
import { T as T$1 } from './color-07edd940.js';
import { i as i$5 } from './TileContainer-6c259836.js';
import { l as l$8 } from './StyleRepository-ba3cad6b.js';
import { f as f$4, d as d$2 } from './LayerView-d595c11d.js';
import './ProgramTemplate-49989acd.js';
import { a as i$7 } from './Container-a2c22c83.js';
import { t as t$8 } from './VertexElementDescriptor-33a64685.js';
import './index-d436d5f8.js';
import './floatRGBA-8b0c35f1.js';
import './enums-63fd0640.js';
import './number-4aaa92a3.js';
import './WGLContainer-fc72d08f.js';
import './definitions-2a5e2c90.js';
import './GeometryUtils-e7f92760.js';
import './alignmentUtils-63467b02.js';
import './earcut-bde06d16.js';
import './featureConversionUtils-aa77f433.js';
import './OptimizedGeometry-d99be84d.js';
import './OptimizedFeatureSet-c30cfe93.js';
import './colorUtils-3c42b70c.js';
import './GeometryUtils-edfc28ec.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
class e$1{constructor(e,t){this._width=0,this._height=0,this._free=[],this._width=e,this._height=t,this._free.push(new t$5(0,0,e,t));}get width(){return this._width}get height(){return this._height}allocate(e,t){if(e>this._width||t>this._height)return new t$5;let i=null,s=-1;for(let h=0;h<this._free.length;++h){const w=this._free[h];e<=w.width&&t<=w.height&&(null===i||w.y<=i.y&&w.x<=i.x)&&(i=w,s=h);}return null===i?new t$5:(this._free.splice(s,1),i.width<i.height?(i.width>e&&this._free.push(new t$5(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new t$5(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new t$5(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new t$5(i.x,i.y+t,e,i.height-t))),new t$5(i.x,i.y,e,t))}release(h){for(let e=0;e<this._free.length;++e){const t=this._free[e];if(t.y===h.y&&t.height===h.height&&t.x+t.width===h.x)t.width+=h.width;else if(t.x===h.x&&t.width===h.width&&t.y+t.height===h.y)t.height+=h.height;else if(h.y===t.y&&h.height===t.height&&h.x+h.width===t.x)t.x=h.x,t.width+=h.width;else {if(h.x!==t.x||h.width!==t.width||h.y+h.height!==t.y)continue;t.y=h.y,t.height+=h.height;}this._free.splice(e,1),this.release(h);}this._free.push(h);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
class n$2{constructor(e,s,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=e,this.height=s,this._glyphSource=i,this._binPack=new e$1(e-4,s-4),this._glyphData.push(new Uint8Array(e*s)),this._dirties.push(!0),this._textures.push(void 0);}getGlyphItems(s,i){const h=[],r=this._glyphSource,n=new Set,o=1/256;for(const t of i){const e=Math.floor(t*o);n.add(e);}const a=[];return n.forEach((t=>{const e=s+t;if(this._rangePromises.has(e))a.push(this._rangePromises.get(e));else {const i=r.getRange(s,t).then((()=>{this._rangePromises.delete(e);}),(()=>{this._rangePromises.delete(e);}));this._rangePromises.set(e,i),a.push(i);}})),Promise.all(a).then((()=>{let n=this._glyphIndex[s];n||(n={},this._glyphIndex[s]=n);for(const o of i){const i=n[o];if(i){h[o]={sdf:!0,rect:i.rect,metrics:i.metrics,page:i.page,code:o};continue}const a=r.getGlyph(s,o);if(!a||!a.metrics)continue;const c=a.metrics;let l;if(0===c.width)l=new t$5(0,0,0,0);else {const e=3,s=c.width+2*e,i=c.height+2*e;let h=s%4?4-s%4:4,r=i%4?4-i%4:4;1===h&&(h=5),1===r&&(r=5),l=this._binPack.allocate(s+h,i+r),l.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new e$1(this.width-4,this.height-4),l=this._binPack.allocate(s+h,i+r));const n=this._glyphData[this._currentPage],o=a.bitmap;let g,_;if(o)for(let t=0;t<i;t++){g=s*t,_=this.width*(l.y+t+1)+l.x;for(let t=0;t<s;t++)n[_+t+1]=o[g+t];}}n[o]={rect:l,metrics:c,tileIDs:null,page:this._currentPage},h[o]={sdf:!0,rect:l,metrics:c,page:this._currentPage,code:o},this._dirties[this._currentPage]=!0;}return h}))}removeGlyphs(t){for(const e in this._glyphIndex){const s=this._glyphIndex[e];if(!s)continue;let i;for(const e in s)if(i=s[e],i.tileIDs.delete(t),0===i.tileIDs.size){const t=this._glyphData[i.page],h=i.rect;let r,n;for(let e=0;e<h.height;e++)for(r=this.width*(h.y+e)+h.x,n=0;n<h.width;n++)t[r+n]=0;delete s[e],this._dirties[i.page]=!0;}}}bind(t,e,n,o=0){if(!this._textures[n]){const e=new e$2;e.pixelFormat=G.ALPHA,e.wrapMode=D$1.CLAMP_TO_EDGE,e.width=this.width,e.height=this.height,this._textures[n]=new T(t,e,new Uint8Array(this.width*this.height));}const a=this._textures[n];a.setSamplingMode(e),this._dirties[n]&&a.setData(this._glyphData[n]),t.bindTexture(a,o),this._dirties[n]=!1;}dispose(){this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
class s$3{constructor(e){if(this._metrics=[],this._bitmaps=[],e)for(;e.next();)switch(e.tag()){case 1:{const t=e.getMessage();for(;t.next();)switch(t.tag()){case 3:{const e=t.getMessage();let s,a,r,n,i,c,g;for(;e.next();)switch(e.tag()){case 1:s=e.getUInt32();break;case 2:a=e.getBytes();break;case 3:r=e.getUInt32();break;case 4:n=e.getUInt32();break;case 5:i=e.getSInt32();break;case 6:c=e.getSInt32();break;case 7:g=e.getUInt32();break;default:e.skip();}e.release(),s&&(this._metrics[s]={width:r,height:n,left:i,top:c,advance:g},this._bitmaps[s]=a);break}default:t.skip();}t.release();break}default:e.skip();}}getMetrics(e){return this._metrics[e]}getBitmap(e){return this._bitmaps[e]}}class a$1{constructor(){this._ranges=[];}getRange(e){return this._ranges[e]}addRange(e,t){this._ranges[e]=t;}}class r$3{constructor(e){this._glyphInfo={},this._baseURL=e;}getRange(a,r){const n=this._getFontStack(a);if(n.getRange(r))return Promise.resolve();const i=256*r,c=i+255;if(this._baseURL){const g=this._baseURL.replace("{fontstack}",a).replace("{range}",i+"-"+c);return j(g,{responseType:"array-buffer"}).then((e=>{n.addRange(r,new s$3(new n$3(new Uint8Array(e.data),new DataView(e.data))));})).catch((()=>{n.addRange(r,new s$3);}))}return n.addRange(r,new s$3),Promise.resolve()}getGlyph(e,t){const s=this._getFontStack(e);if(!s)return;const a=Math.floor(t/256),r=s.getRange(a);return r?{metrics:r.getMetrics(t),bitmap:r.getBitmap(t)}:void 0}_getFontStack(e){let t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new a$1),t}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
const r$2="dasharray-";class o$4{constructor(t,e,s=0){this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,(t<=0||e<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=e,s>0&&(this._maxItemSize=s),this._binPack=new e$1(t-4,e-4);}dispose(){this._binPack=null,this._mosaicRects={};for(const t of this._textures)t&&t.dispose();this._textures.length=0;}getWidth(t){return t>=this._size.length?-1:this._size[t][0]}getHeight(t){return t>=this._size.length?-1:this._size[t][1]}getPageSize(t){return t>=this._size.length?null:this._size[t]}setSpriteSource(t){if(this.dispose(),this.pixelRatio=t.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new e$1(this._pageWidth-4,this._pageHeight-4);const t=Math.floor(this._pageWidth),e=Math.floor(this._pageHeight),s=new Uint32Array(t*e);this._mosaicsData[0]=s,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0);}this._sprites=t;}getSpriteItem(t,i=!1){let e,s,h=this._mosaicRects[t];if(h)return h;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;if(t&&t.startsWith(r$2)?([e,s]=this._rasterizeDash(t),i=!0):e=this._sprites.getSpriteInfo(t),!e||!e.width||!e.height||e.width<0||e.height<0)return null;const a=e.width,o=e.height,[n,_,g]=this._allocateImage(a,o);return n.width<=0?null:(this._copy(n,e,_,g,i,s),h={rect:n,width:a,height:o,sdf:e.sdf,simplePattern:!1,pixelRatio:e.pixelRatio,page:_},this._mosaicRects[t]=h,h)}getSpriteItems(t){const i={};for(const e of t)i[e.name]=this.getSpriteItem(e.name,e.repeat);return i}getMosaicItemPosition(t,i){const e=this.getSpriteItem(t,i),s=e&&e.rect;if(!s)return null;s.width=e.width,s.height=e.height;const h=e.width,a=e.height,r=2;return {tl:[s.x+r,s.y+r],br:[s.x+r+h,s.y+r+a],page:e.page}}bind(t,i,e=0,r=0){if(e>=this._size.length||e>=this._mosaicsData.length)return;if(!this._textures[e]){const i=new e$2;i.wrapMode=D$1.CLAMP_TO_EDGE,i.width=this._size[e][0],i.height=this._size[e][1],this._textures[e]=new T(t,i,new Uint8Array(this._mosaicsData[e].buffer));}const o=this._textures[e];o.setSamplingMode(i),this._dirties[e]&&o.setData(new Uint8Array(this._mosaicsData[e].buffer)),t.bindTexture(o,r),this._dirties[e]=!1;}static _copyBits(t,i,e,s,h,a,r,o,n,_,g){let c=s*i+e,l=o*a+r;if(g){l-=a;for(let r=-1;r<=_;r++,c=((r+_)%_+s)*i+e,l+=a)for(let i=-1;i<=n;i++)h[l+i]=t[c+(i+n)%n];}else for(let p=0;p<_;p++){for(let i=0;i<n;i++)h[l+i]=t[c+i];c+=i,l+=a;}}_copy(t,i,e,s,h,a){if(!this._sprites||"loaded"!==this._sprites.loadStatus||e>=this._mosaicsData.length)return;const r=new Uint32Array(a?a.buffer:this._sprites.image.buffer),n=this._mosaicsData[e];n&&r||console.error("Source or target images are uninitialized!");const _=2,g=a?i.width:this._sprites.width;o$4._copyBits(r,g,i.x,i.y,n,s[0],t.x+_,t.y+_,i.width,i.height,h),this._dirties[e]=!0;}_allocateImage(t,s){t+=2,s+=2;const h=Math.max(t,s);if(this._maxItemSize&&this._maxItemSize<h){const i=new t$5(0,0,t,s);return this._mosaicsData.push(new Uint32Array(t*s)),this._dirties.push(!0),this._size.push([t,s]),this._textures.push(void 0),[i,this._mosaicsData.length-1,[t,s]]}let a=t%4?4-t%4:4,r=s%4?4-s%4:4;1===a&&(a=5),1===r&&(r=5);const o=this._binPack.allocate(t+a,s+r);return o.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new e$1(this._pageWidth-4,this._pageHeight-4),this._allocateImage(t,s)):[o,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(i){const e=/\[(.*?)\]/,s=i.match(e);if(!s)return null;const h=s[1].split(",").map(Number),a=i.slice(i.lastIndexOf("-")+1),[r,o,n]=e$3(h,a);return [{x:0,y:0,width:o,height:n,sdf:!0,pixelRatio:1},new Uint8Array(r.buffer)]}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
class h$1{constructor(t,e,s){this._layer=t,this._styleRepository=e,this.devicePixelRatio=s,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._spriteSourceAbortController=null,this._startOptionsInputSignal=null,this._inputSignalEventListener=null;}destroy(){this._connection?.close(),this._connection=null,this._styleRepository=null,this._layer=null,this._spriteMosaic=null,this._glyphMosaic=null,this._spriteSourceAbortController=e$4(this._spriteSourceAbortController),this._spriteSourcePromise=null,this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,this._inputSignalEventListener=null;}get spriteMosaic(){return this._spriteSourcePromise.then((()=>this._spriteMosaic))}get glyphMosaic(){return this._glyphMosaic}async start(t){this._requestSprite(t);const s=this._layer.currentStyleInfo.glyphsUrl,r=new r$3(s?kt(s,{...this._layer.customParameters,token:this._layer.apiKey}):null);this._glyphMosaic=new n$2(1024,1024,r),this._broadcastPromise=f$1("WorkerTileHandler",{client:this,schedule:t.schedule,signal:t.signal}).then((s=>{if(this._layer&&(this._connection?.close(),this._connection=s,this._layer&&!this._connection.closed)){const r=s.broadcast("setStyle",this._layer.currentStyleInfo.style,t);Promise.all(r).catch((t=>m$2(t)));}}));}_requestSprite(t){this._spriteSourceAbortController?.abort();const e=new AbortController;this._spriteSourceAbortController=e;const r=t?.signal;this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,r&&(this._inputSignalEventListener=p$2(e),r.addEventListener("abort",this._inputSignalEventListener,{once:!0}));const{signal:i}=e,o={...t,signal:i};this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,o),this._spriteSourcePromise.then((t=>{f$2(i),this._spriteMosaic=new o$4(1024,1024,250),this._spriteMosaic.setSpriteSource(t);}));}async updateStyle(t){return await this._broadcastPromise,this._broadcastPromise=Promise.all(this._connection.broadcast("updateStyle",t)),this._broadcastPromise}setSpriteSource(t){const e=new o$4(1024,1024,250);return e.setSpriteSource(t),this._spriteMosaic=e,this._spriteSourcePromise=Promise.resolve(t),this._spriteSourceAbortController=null,e}async setStyle(t,e){await this._broadcastPromise,this._styleRepository=t,this._requestSprite();const s=new r$3(this._layer.currentStyleInfo.glyphsUrl?kt(this._layer.currentStyleInfo.glyphsUrl,{...this._layer.customParameters,token:this._layer.apiKey}):null);return this._glyphMosaic=new n$2(1024,1024,s),this._broadcastPromise=Promise.all(this._connection.broadcast("setStyle",e)),this._broadcastPromise}fetchTileData(t,e){return this._getRefKeys(t,e).then((t=>{const s=this._layer.sourceNameToSource,r=[];for(const e in s)r.push(e);return this._getSourcesData(r,t,e)}))}parseTileData(t,e){const s=t&&t.data;if(!s)return Promise.resolve(null);const{sourceName2DataAndRefKey:r,transferList:i}=s;return 0===Object.keys(r).length?Promise.resolve(null):this._broadcastPromise.then((()=>this._connection.invoke("createTileAndParse",{key:t.key.id,sourceName2DataAndRefKey:r,styleLayerUIDs:t.styleLayerUIDs},{...e,transferList:i})))}async getSprites(t){return await this._spriteSourcePromise,this._spriteMosaic.getSpriteItems(t)}getGlyphs(t){return this._glyphMosaic.getGlyphItems(t.font,t.codePoints)}async _getTilePayload(t,e,s){const i=e$5.pool.acquire(t.id),o=this._layer.sourceNameToSource[e],{level:n,row:l,col:a}=i;e$5.pool.release(i);try{return {protobuff:await o.requestTile(n,l,a,s),sourceName:e}}catch(c){if(d$1(c))throw c;return {protobuff:null,sourceName:e}}}_getRefKeys(t,e){const s=this._layer.sourceNameToSource,r=new Array;for(const i in s){const o=s[i].getRefKey(t,e);r.push(o);}return j$1(r)}_getSourcesData(t,e,s){const r=[];for(let i=0;i<e.length;i++)if(null==e[i].value||null==t[i])r.push(null);else {const o=this._getTilePayload(e[i].value,t[i],s);r.push(o);}return j$1(r).then((t=>{const s={},r=[];for(let i=0;i<t.length;i++){const o=t[i].value;if(o&&(o.protobuff&&o.protobuff.byteLength>0)){const t=e[i].value.id;s[o.sourceName]={refKey:t,protobuff:o.protobuff},r.push(o.protobuff);}}return {sourceName2DataAndRefKey:s,transferList:r}}))}}function p$2(t){return ()=>t.abort()}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
const l$5=512,s$2=1e-6,r$1=(e,i)=>e+1/(1<<2*i);class o$3{constructor(i,t){this._tiles=new Map,this._tileCache=new e$6(40,(e=>e.dispose())),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=i.acquireTile,this.releaseTile=i.releaseTile,this.tileInfoView=i.tileInfoView,this._container=t;}destroy(){for(const[e,i]of this._tiles)i.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null;}update(e){this._updateCacheSize(e);const l=this.tileInfoView,s=l.getTileCoverage(e.state,0,!0,"smallest"),{spans:r,lodInfo:o}=s,{level:n}=o,a=this._tiles,c=new Set,h=new Set;for(const{row:i,colFrom:_,colTo:f}of r)for(let e=_;e<=f;e++){const l=e$5.getId(n,i,o.normalizeCol(e),o.getWorldForColumn(e)),s=this._getOrAcquireTile(l);c.add(l),s.processed()?this._addToContainer(s):h.add(new e$5(l));}for(const[i,t]of a)t.isCoverage=c.has(i);for(const i of h)this._findPlaceholdersForMissingTiles(i,c);let d=!1;for(const[i,t]of a)t.neededForCoverage=c.has(i),t.neededForCoverage||t.isHoldingForFade&&l.intersects(s,t.key)&&c.add(i),t.isFading&&(d=!0);for(const[i,t]of this._tiles)c.has(i)||this._releaseTile(i);return l$6.pool.release(s),!d}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear();}clearCache(){this._tileCache.clear();}_findPlaceholdersForMissingTiles(e,i){const t=[];for(const[s,r]of this._tiles)this._addPlaceholderChild(t,r,e,i);const l=t.reduce(r$1,0);Math.abs(1-l)<s$2||this._addPlaceholderParent(e.id,i);}_addPlaceholderChild(e,i,t,l){i.key.level<=t.level||!i.hasData()||a(t,i.key)&&(this._addToContainer(i),l.add(i.id),e.push(i.key.level-t.level));}_addPlaceholderParent(e,i){const t=this._tiles;let l=e;for(;;){if(l=n$1(l),!l||i.has(l))return;const e=t.get(l);if(e&&e.hasData())return this._addToContainer(e),void i.add(e.id)}}_getOrAcquireTile(e){let i=this._tiles.get(e);return i||(i=this._tileCache.pop(e),i||(i=this.acquireTile(new e$5(e))),this._tiles.set(e,i),i)}_releaseTile(e){const i=this._tiles.get(e);this.releaseTile(i),this._removeFromContainer(i),this._tiles.delete(e),i.hasData()?this._tileCache.put(e,i,1):i.dispose();}_addToContainer(e){let i;const t=[],l=this._container;if(l.contains(e))return;const s=this._visibleTiles;for(const[r,o]of s)this._canConnectDirectly(e,o)&&t.push(o),null==i&&this._canConnectDirectly(o,e)&&(i=o);if(null!=i){for(const l of t)i.childrenTiles.delete(l),e.childrenTiles.add(l),l.parentTile=e;i.childrenTiles.add(e),e.parentTile=i;}else for(const r of t)e.childrenTiles.add(r),r.parentTile=e;s.set(e.id,e),l.addChild(e);}_removeFromContainer(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),null!=e.parentTile){e.parentTile.childrenTiles.delete(e);for(const i of e.childrenTiles)null!=e.parentTile&&e.parentTile.childrenTiles.add(i);}for(const i of e.childrenTiles)i.parentTile=e.parentTile;e.parentTile=null,e.childrenTiles.clear();}_canConnectDirectly(e,i){const t=e.key;let{level:l,row:s,col:r,world:o}=i.key;const n=this._visibleTiles;for(;l>0;){if(l--,s>>=1,r>>=1,t.level===l&&t.row===s&&t.col===r&&t.world===o)return !0;if(n.has(`${l}/${s}/${r}/${o}`))return !1}return !1}_updateCacheSize(e){const i=e.state.size;if(i[0]===this._viewSize[0]&&i[1]===this._viewSize[1])return;const t=Math.ceil(i[0]/l$5)+1,s=Math.ceil(i[1]/l$5)+1;this._viewSize[0]=i[0],this._viewSize[1]=i[1],this._tileCache.maxSize=5*t*s;}}function n$1(e){const[i,t,l,s]=e.split("/"),r=parseInt(i,10);return 0===r?null:`${r-1}/${parseInt(t,10)>>1}/${parseInt(l,10)>>1}/${parseInt(s,10)}`}function a(e,i){const t=i.level-e.level;return e.row===i.row>>t&&e.col===i.col>>t&&e.world===i.world}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
class t$4{constructor(t){this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=t;}}class s$1{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
function s(t,e,s,o,l,i){const r=s-l;if(r>=0)return (e>>r)+(o-(i<<r))*(t>>r);const n=-r;return e-(i-(o<<n))*(t>>n)<<n}class o$2{constructor(t,e,s){this._rows=Math.ceil(e/s),this._columns=Math.ceil(t/s),this._cellSize=s,this.cells=new Array(this._rows);for(let o=0;o<this._rows;o++){this.cells[o]=new Array(this._columns);for(let t=0;t<this._columns;t++)this.cells[o][t]=[];}}getCell(t,e){const s=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._rows-1),o=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._columns-1);return this.cells[s]&&this.cells[s][o]||null}getCellSpan(t,e,s,o){return [Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(e/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(o/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function l$4(t,s,o,l,i,r){const n=s[l++];for(let a=0;a<n;a++){const n=new t$4(r);n.xTile=s[l++],n.yTile=s[l++],n.hash=s[l++],n.priority=s[l++];const a=s[l++];for(let t=0;t<a;t++){const t=s[l++],e=s[l++],i=s[l++],r=s[l++],a=!!s[l++],c=s[l++],h=o[l++],f=o[l++],u=s[l++],m=s[l++];n.colliders.push({xTile:t,yTile:e,dxPixels:i,dyPixels:r,hard:a,partIndex:c,width:u,height:m,minLod:h,maxLod:f});}const c=t[l++];for(let e=0;e<c;e++)n.textVertexRanges.push([t[l++],t[l++]]);const h=t[l++];for(let e=0;e<h;e++)n.iconVertexRanges.push([t[l++],t[l++]]);i.push(n);}return l}function i$3(t,e,s){for(const[o,l]of t.symbols)r(t,e,s,l,o);}function r(e,s,o,l,i){const r=e.layerData.get(i);if(r.type===E.SYMBOL){for(const t of l){const s=t.unique;let l;if(t.selectedForRendering){const t=s.parts[0],i=t.startOpacity,r=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===r;const n=o?Math.floor(127*i)|r<<7:r?255:0;l=n<<24|n<<16|n<<8|n;}else l=0;for(const[e,o]of t.iconVertexRanges)for(let t=e;t<e+o;t+=4)r.iconOpacity[t/4]=l;if(t.selectedForRendering){const t=s.parts[1],i=t.startOpacity,r=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===r;const n=o?Math.floor(127*i)|r<<7:r?255:0;l=n<<24|n<<16|n<<8|n;}else l=0;for(const[e,o]of t.textVertexRanges)for(let t=e;t<e+o;t+=4)r.textOpacity[t/4]=l;}r.lastOpacityUpdate=s,r.opacityChanged=!0;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
class o$1{constructor(t,e){this.layerUIDs=[],this.isDestroyed=!1,this._data=t;let r=1;const n=new Uint32Array(t);this.layerUIDs=[];const s=n[r++];for(let i=0;i<s;i++)this.layerUIDs[i]=n[r++];this.bufferDataOffset=r,e&&(this.layer=e.getStyleLayerByUID(this.layerUIDs[0]));}get isPreparedForRendering(){return null==this._data}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0);}prepareForRendering(t){null!=this._data&&(this.doPrepareForRendering(t,this._data,this.bufferDataOffset),this._data=null);}}class h extends o$1{constructor(t,e){super(t,e),this.type=E.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const n=new Uint32Array(t);let s=this.bufferDataOffset;this.lineIndexStart=n[s++],this.lineIndexCount=n[s++];const i=n[s++];if(i>0){this.patternMap=new Map;for(let t=0;t<i;t++){const t=n[s++],e=n[s++],r=n[s++];this.patternMap.set(t,[e,r]);}}this.bufferDataOffset=s;}get memoryUsed(){return (this.data?.byteLength??0)+(this.vao?.memoryEstimate??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=t$6(this.vao);}doPrepareForRendering(t,e,r){const n=new Uint32Array(e),o=new Int32Array(n.buffer),h=n[r++],f=c$2.createVertex(t,F.STATIC_DRAW,new Int32Array(o.buffer,4*r,h));r+=h;const c=n[r++],l=c$2.createIndex(t,F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,c));r+=c;const y=this.layer.lineMaterial;this.vao=new u$2(t,y.getAttributeLocations(),y.getLayoutInfo(),{geometry:f},l);}}class f extends o$1{constructor(t,e){super(t,e),this.type=E.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const n=new Uint32Array(t);let s=this.bufferDataOffset;this.fillIndexStart=n[s++],this.fillIndexCount=n[s++],this.outlineIndexStart=n[s++],this.outlineIndexCount=n[s++];const i=n[s++];if(i>0){this.patternMap=new Map;for(let t=0;t<i;t++){const t=n[s++],e=n[s++],r=n[s++];this.patternMap.set(t,[e,r]);}}this.bufferDataOffset=s;}get memoryUsed(){return (this.data?.byteLength??0)+(this.fillVAO?.memoryEstimate??0)+(this.outlineVAO?.memoryEstimate??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return (this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=t$6(this.fillVAO),this.outlineVAO=t$6(this.outlineVAO);}doPrepareForRendering(t,e,r){const n=new Uint32Array(e),o=new Int32Array(n.buffer),h=n[r++],f=c$2.createVertex(t,F.STATIC_DRAW,new Int32Array(o.buffer,4*r,h));r+=h;const c=n[r++],l=c$2.createIndex(t,F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,c));r+=c;const y=n[r++],u=c$2.createVertex(t,F.STATIC_DRAW,new Int32Array(o.buffer,4*r,y));r+=y;const A=n[r++],d=c$2.createIndex(t,F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,A));r+=A;const I=this.layer,g=I.fillMaterial,p=I.outlineMaterial;this.fillVAO=new u$2(t,g.getAttributeLocations(),g.getLayoutInfo(),{geometry:f},l),this.outlineVAO=new u$2(t,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:u},d);}}class c$1 extends o$1{constructor(t,e,s){super(t,e),this.type=E.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const i=new Uint32Array(t),a=new Int32Array(t),o=new Float32Array(t);let h=this.bufferDataOffset;this.isIconSDF=!!i[h++];const f=i[h++];for(let r=0;r<f;r++){const t=i[h++],e=i[h++],r=i[h++];this.iconPerPageElementsMap.set(t,[e,r]);}const c=i[h++];for(let r=0;r<c;r++){const t=i[h++],e=i[h++],r=i[h++];this.glyphPerPageElementsMap.set(t,[e,r]);}const l=i[h++],y=i[h++];this.iconOpacity=new Int32Array(l),this.textOpacity=new Int32Array(y),h=l$4(i,a,o,h,this.symbols,s),this.bufferDataOffset=h;}get memoryUsed(){return (this.data?.byteLength??0)+(this.iconVAO?.memoryEstimate??0)+(this.textVAO?.memoryEstimate??0)+m$3(this.iconOpacity)+m$3(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let t=0;for(const[e,r]of this.iconPerPageElementsMap)t+=r[1];for(const[e,r]of this.glyphPerPageElementsMap)t+=r[1];return t/3}doDestroy(){this.iconVAO=t$6(this.iconVAO),this.textVAO=t$6(this.textVAO);}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const t=this.iconOpacity,e=this.iconVAO.vertexBuffers.opacity;t.length>0&&t.byteLength===e.byteLength&&e.setSubData(t,0,0,t.length);const r=this.textOpacity,n=this.textVAO.vertexBuffers.opacity;r.length>0&&r.byteLength===n.byteLength&&n.setSubData(r,0,0,r.length);}doPrepareForRendering(t,e,r){const n=new Uint32Array(e),o=new Int32Array(n.buffer),h=n[r++],f=c$2.createVertex(t,F.STATIC_DRAW,new Int32Array(o.buffer,4*r,h));r+=h;const c=n[r++],l=c$2.createIndex(t,F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,c));r+=c;const y=n[r++],u=c$2.createVertex(t,F.STATIC_DRAW,new Int32Array(o.buffer,4*r,y));r+=y;const A=n[r++],d=c$2.createIndex(t,F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,A));r+=A;const I=c$2.createVertex(t,F.STATIC_DRAW,this.iconOpacity.buffer),g=c$2.createVertex(t,F.STATIC_DRAW,this.textOpacity.buffer),p=this.layer,m=p.iconMaterial,x=p.textMaterial;this.iconVAO=new u$2(t,m.getAttributeLocations(),m.getLayoutInfo(),{geometry:f,opacity:I},l),this.textVAO=new u$2(t,x.getAttributeLocations(),x.getLayoutInfo(),{geometry:u,opacity:g},d);}}class l$3 extends o$1{constructor(t,e){super(t,e),this.type=E.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const n=new Uint32Array(t);let s=this.bufferDataOffset;this.circleIndexStart=n[s++],this.circleIndexCount=n[s++],this.bufferDataOffset=s;}get memoryUsed(){return (this.data?.byteLength??0)+(this.vao?.memoryEstimate??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=t$6(this.vao);}doPrepareForRendering(t,e,r){const n=new Uint32Array(e),o=new Int32Array(n.buffer),h=n[r++],f=c$2.createVertex(t,F.STATIC_DRAW,new Int32Array(o.buffer,4*r,h));r+=h;const c=n[r++],l=c$2.createIndex(t,F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,c));r+=c;const y=this.layer.circleMaterial;this.vao=new u$2(t,y.getAttributeLocations(),y.getLayoutInfo(),{geometry:f},l);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
class d extends r$4{constructor(e,t,s,a,r,i,o,h=null){super(e,t,s,a,r,i,4096,4096),this.styleRepository=o,this._memCache=h,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.layerCount=0,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.invalidating=!1,this.parentTile=null,this.childrenTiles=new Set,this._processed=!1,this._referenced=1,this.id=e.id;}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<e$7}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<e$7)}get wasRequested(){return "errored"===this.status||"loaded"===this.status||"reloading"===this.status}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0;}deleteLayerData(e){let t=!1;for(const s of e)if(this.layerData.has(s)){const e=this.layerData.get(s);this._memoryUsedByLayerData-=e.memoryUsed,e.type===E.SYMBOL&&this.symbols.has(s)&&(this.symbols.delete(s),t=!0),e.destroy(),this.layerData.delete(s),this.layerCount--;}this._memCache?.updateSize(this.key.id,this,this._memoryUsedByLayerData),t&&this.emit("symbols-changed"),this.requestRender();}processed(){return this._processed}hasData(){return this.layerCount>0}dispose(){"unloaded"!==this.status&&(m$1.delete(this),d._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded");}release(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced;}get referenced(){return this._referenced}get memoryUsed(){return this._memoryUsedByLayerData+256}changeDataImpl(e){let t=!1;if(e){const{bucketsWithData:s,emptyBuckets:a}=e,r=this._createRenderBuckets(s);if(a&&a.byteLength>0){const e=new Uint32Array(a);for(const t of e)this._deleteLayerData(t);}for(const[e,o]of r)this._deleteLayerData(e),o.type===E.SYMBOL&&(this.symbols.set(e,o.symbols),t=!0),this._memoryUsedByLayerData+=o.memoryUsed,this.layerData.set(e,o),this.layerCount++;this._memCache?.updateSize(this.key.id,this,this.memoryUsed);}this._hasSymbolBuckets=!1;for(const[s,a]of this.layerData)a.type===E.SYMBOL&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed");}attachWithContext(e){this.stage={context:e,trashDisplayObject(e){e.processDetach();},untrashDisplayObject:()=>!1};}setTransform(r){super.setTransform(r);const i=this.resolution/(r.resolution*r.pixelRatio),o=this.width/this.rangeX*i,h=this.height/this.rangeY*i,n=[0,0];r.toScreen(n,[this.x,this.y]);const l=this.transforms.tileUnitsToPixels;r$5(l),M(l,l,n),h$2(l,l,Math.PI*r.rotation/180),f$3(l,l,[o,h,1]);}_createTransforms(){return {dvs:e$8(),tileMat3:e$8(),tileUnitsToPixels:e$8()}}static _destroyRenderBuckets(e){if(!e)return;const t=new Set;e.forEach((e=>{t.has(e)||(e.destroy(),t.add(e));})),e.clear();}_createRenderBuckets(e){const t=new Map,s=new Map;for(const a of e){const e=this._deserializeBucket(a,s);for(const s of e.layerUIDs)t.set(s,e);}return t}_deserializeBucket(e,t){let s=t.get(e);if(s)return s;switch(new Uint32Array(e)[0]){case E.FILL:s=new f(e,this.styleRepository);break;case E.LINE:s=new h(e,this.styleRepository);break;case E.SYMBOL:s=new c$1(e,this.styleRepository,this);break;case E.CIRCLE:s=new l$3(e,this.styleRepository);}return t.set(e,s),s}_deleteLayerData(e){if(!this.layerData.has(e))return;const t=this.layerData.get(e);this._memoryUsedByLayerData-=t.memoryUsed,t.destroy(),this.layerData.delete(e),this.layerCount--;}}const m$1=new Map;function u$1(){m$1.forEach(((e,t)=>{console.log(`\n${t.key}:`),e[0].forEach((e=>console.log(e))),console.log("========"),e[1].forEach((e=>console.log(e)));}));}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
function i$2(e,t,n,o,i,l){const{iconRotationAlignment:a,textRotationAlignment:c,iconTranslate:h,iconTranslateAnchor:u,textTranslate:d,textTranslateAnchor:y}=o;let x=0;for(const g of e.colliders){const[e,o]=0===g.partIndex?h:d,m=0===g.partIndex?u:y,f=g.minLod<=l&&l<=g.maxLod;x+=f?0:1,g.enabled=f,g.xScreen=g.xTile*i[0]+g.yTile*i[3]+i[6],g.yScreen=g.xTile*i[1]+g.yTile*i[4]+i[7],m===r$6.MAP?(g.xScreen+=n*e-t*o,g.yScreen+=t*e+n*o):(g.xScreen+=e,g.yScreen+=o),l$7.VIEWPORT===(0===g.partIndex?a:c)?(g.dxScreen=g.dxPixels,g.dyScreen=g.dyPixels):(g.dxScreen=n*(g.dxPixels+g.width/2)-t*(g.dyPixels+g.height/2)-g.width/2,g.dyScreen=t*(g.dxPixels+g.width/2)+n*(g.dyPixels+g.height/2)-g.height/2);}e.colliders.length>0&&x===e.colliders.length&&(e.unique.show=!1);}class l$2{constructor(o,r,s,i,l,a){this._symbols=o,this._styleRepository=i,this._zoom=l,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new o$2(r,s,t$7),this._si=Math.sin(Math.PI*a/180),this._co=Math.cos(Math.PI*a/180);for(const t of o)for(const n of t.symbols)this._allNeededMatrices.has(n.tile)||this._allNeededMatrices.set(n.tile,r$7(n.tile.transforms.tileUnitsToPixels));}work(e){const t=this._gridIndex;function n(e){const n=e.xScreen+e.dxScreen,o=e.yScreen+e.dyScreen,r=n+e.width,s=o+e.height,[i,l,a,c]=t.getCellSpan(n,o,r,s);for(let h=l;h<=c;h++)for(let e=i;e<=a;e++){const i=t.cells[h][e];for(const e of i){const t=e.xScreen+e.dxScreen,i=e.yScreen+e.dyScreen,l=t+e.width,a=i+e.height;if(!(r<t||n>l||s<i||o>a))return !0}}return !1}const o=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const t=this._symbols[this._currentLayerCursor],r=this._getProperties(t.styleLayerUID);for(;this._currentSymbolCursor<t.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-o>e)return !1;const s=t.symbols[this._currentSymbolCursor];if(!s.unique.show)continue;i$2(s,this._si,this._co,r,this._allNeededMatrices.get(s.tile),this._zoom);const l=s.unique;if(!l.show)continue;const{iconAllowOverlap:a,iconIgnorePlacement:c,textAllowOverlap:h,textIgnorePlacement:u}=r;for(const e of s.colliders){if(!e.enabled)continue;const t=l.parts[e.partIndex];if(!t.show)continue;!(e.partIndex?h:a)&&n(e)&&(e.hard?l.show=!1:t.show=!1);}if(l.show)for(const e of s.colliders){if(!e.enabled)continue;if(e.partIndex?u:c)continue;if(!l.parts[e.partIndex].show)continue;const t=e.xScreen+e.dxScreen,n=e.yScreen+e.dyScreen,o=t+e.width,r=n+e.height,[s,i,a,h]=this._gridIndex.getCellSpan(t,n,o,r);for(let l=i;l<=h;l++)for(let t=s;t<=a;t++){this._gridIndex.cells[l][t].push(e);}}}}return !0}_getProperties(e){const t=this._styleProps.get(e);if(t)return t;const n=this._zoom,s=this._styleRepository.getStyleLayerByUID(e),i=s.getLayoutValue("symbol-placement",n)!==n$4.POINT;let l=s.getLayoutValue("icon-rotation-alignment",n);l===l$7.AUTO&&(l=i?l$7.MAP:l$7.VIEWPORT);let a=s.getLayoutValue("text-rotation-alignment",n);a===l$7.AUTO&&(a=i?l$7.MAP:l$7.VIEWPORT);const c=s.getPaintValue("icon-translate",n),h=s.getPaintValue("icon-translate-anchor",n),u=s.getPaintValue("text-translate",n),d=s.getPaintValue("text-translate-anchor",n),y={iconAllowOverlap:s.getLayoutValue("icon-allow-overlap",n),iconIgnorePlacement:s.getLayoutValue("icon-ignore-placement",n),textAllowOverlap:s.getLayoutValue("text-allow-overlap",n),textIgnorePlacement:s.getLayoutValue("text-ignore-placement",n),iconRotationAlignment:l,textRotationAlignment:a,iconTranslateAnchor:h,iconTranslate:c,textTranslateAnchor:d,textTranslate:u};return this._styleProps.set(e,y),y}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
function t$3(o,t){if(o.priority-t.priority)return o.priority-t.priority;const e=o.tile.key,i=t.tile.key;return e.world-i.world?e.world-i.world:e.level-i.level?e.level-i.level:e.row-i.row?e.row-i.row:e.col-i.col?e.col-i.col:o.xTile-t.xTile?o.xTile-t.xTile:o.yTile-t.yTile}class e{get running(){return this._running}constructor(o,t,e,i,s,n){this._visibleTiles=o,this._symbolRepository=t,this._createCollisionJob=e,this._assignTileSymbolsOpacity=i,this._symbolLayerSorter=s,this._isLayerVisible=n,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0;}setScreenSize(o,t){this._screenWidth===o&&this._screenHeight===t||this.restart(),this._screenWidth=o,this._screenHeight=t;}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0;}continue(o){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const t=performance.now();if(!this._selectionJob.work(o))return !1;if(this._selectionJobCompleted=!0,0===(o=Math.max(0,o-(performance.now()-t))))return !1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const t=performance.now();if(!this._collisionJob.work(o))return !1;if(this._collisionJobCompleted=!0,0===(o=Math.max(0,o-(performance.now()-t))))return !1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const t=performance.now();if(!this._opacityJob.work(o))return !1;if(this._opacityJobCompleted=!0,0===(o=Math.max(0,o-(performance.now()-t))))return !1}return this._running=!1,!0}_createSelectionJob(){const o=this._symbolRepository.uniqueSymbols;for(let t=0;t<o.length;t++){const e=o[t];for(let o=0;o<e.uniqueSymbols.length;o++){const t=e.uniqueSymbols[o];for(const o of t.tileSymbols)o.selectedForRendering=!1;}}const e=[];let i=0,s=0;const n=this._isLayerVisible;function r(r){let l;const c=performance.now();for(;s<o.length;s++,i=0){const t=o[s],h=t.styleLayerUID;if(!n(h)){e[s]||(e[s]={styleLayerUID:h,symbols:[]});continue}e[s]=e[s]||{styleLayerUID:h,symbols:[]};const a=e[s];for(;i<t.uniqueSymbols.length;i++){if(l=t.uniqueSymbols[i],i%100==99&&performance.now()-c>r)return !1;let o=null,e=!1,s=!1;for(const t of l.tileSymbols)if(!s||!e){const i=t.tile;(!o||i.isCoverage||i.neededForCoverage&&!e)&&(o=t,(i.neededForCoverage||i.isCoverage)&&(s=!0),i.isCoverage&&(e=!0));}if(o.selectedForRendering=!0,s){a.symbols.push(o),l.show=!0;for(const o of l.parts)o.show=!0;}else l.show=!1;}}for(const o of e)o.symbols.sort(t$3);return !0}const l=this._symbolLayerSorter;return {work:r,get sortedSymbols(){return e.sort(l)}}}_createOpacityJob(){const o=this._assignTileSymbolsOpacity,t=this._visibleTiles;let e=0;function s(t,e){const n=t.symbols;for(const[o,s]of n)i$1(s,e);o(t,e);for(const o of t.childrenTiles)s(o,e);}return {work(o){const i=performance.now();for(;e<t.length;e++){if(performance.now()-i>o)return !1;const n=t[e];if(null!=n.parentTile)continue;s(n,performance.now());}return !0}}}}function i$1(t,e){for(const i of t){const t=i.unique;for(const i of t.parts){const s=i.targetOpacity>.5?1:-1;i.startOpacity+=s*((e-i.startTime)/e$7),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=e,i.targetOpacity=t.show&&i.show?1:0;}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
const l$1=32,o=8,t$2=64;class i{constructor(e,s,l){this.tileCoordRange=e,this._visibleTiles=s,this._createUnique=l,this._tiles=new Map,this._uniqueSymbolsReferences=new Map;}get uniqueSymbols(){return null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}add(s,i){this._uniqueSymbolLayerArray=null;let n=this._tiles.get(s.id);n||(n={symbols:new Map},this._tiles.set(s.id,n));const r=new Map;if(i)for(const e of i)n.symbols.has(e)&&(r.set(e,n.symbols.get(e)),n.symbols.delete(e));else for(const[e,l]of s.layerData)n.symbols.has(e)&&(r.set(e,n.symbols.get(e)),n.symbols.delete(e));this._removeSymbols(r);const y=s.symbols,a=new Map;for(const[f,c]of y){let s=c.length;if(s>=l$1){let l=this.tileCoordRange;do{l/=2,s/=4;}while(s>o&&l>t$2);const i=new o$2(this.tileCoordRange,this.tileCoordRange,l);a.set(f,{flat:c,index:i}),n.symbols.set(f,{flat:c,index:i});for(const e of c)i.getCell(e.xTile,e.yTile).push(e);}else a.set(f,{flat:c}),n.symbols.set(f,{flat:c});}this._addSymbols(s.key,y);}deleteStyleLayers(e){this._uniqueSymbolLayerArray=null;for(const[s,l]of this._tiles){const o=new Map;for(const s of e)l.symbols.has(s)&&(o.set(s,l.symbols.get(s)),l.symbols.delete(s));this._removeSymbols(o),0===l.symbols.size&&this._tiles.delete(s);}}removeTile(e){this._uniqueSymbolLayerArray=null;const s=this._tiles.get(e.id);if(!s)return;const l=new Map;for(const[o,t]of e.symbols)s.symbols.has(o)&&(l.set(o,s.symbols.get(o)),s.symbols.delete(o));this._removeSymbols(l),0===s.symbols.size&&this._tiles.delete(e.id);}_removeSymbols(e){for(const[s,{flat:l}]of e)for(const e of l){const l=e.unique,o=l.tileSymbols,t=o.length-1;for(let s=0;s<t;s++)if(o[s]===e){o[s]=o[t];break}if(o.length=t,0===t){const e=this._uniqueSymbolsReferences.get(s);e.delete(l),0===e.size&&this._uniqueSymbolsReferences.delete(s);}e.unique=null;}}_addSymbols(e,s){if(0===s.size)return;const l=this._visibleTiles;for(const o of l)o.parentTile||o.key.world!==e.world||o.key.level===e.level&&!o.key.equals(e)||this._matchSymbols(o,e,s);for(const[o,t]of s)for(const e of t)if(null==e.unique){const s=this._createUnique();e.unique=s,s.tileSymbols.push(e);let l=this._uniqueSymbolsReferences.get(o);l||(l=new Set,this._uniqueSymbolsReferences.set(o,l)),l.add(s);}}_matchSymbols(e,l,o){if(e.key.level>l.level){const s=e.key.level-l.level;if(e.key.row>>s!==l.row||e.key.col>>s!==l.col)return}if(l.level>e.key.level){const s=l.level-e.key.level;if(l.row>>s!==e.key.row||l.col>>s!==e.key.col)return}if(l.equals(e.key)){for(const s of e.childrenTiles)this._matchSymbols(s,l,o);return}const t=new Map;for(const[i,n]of o){const o=[];for(const t of n){const i=s(this.tileCoordRange,t.xTile,l.level,l.col,e.key.level,e.key.col),n=s(this.tileCoordRange,t.yTile,l.level,l.row,e.key.level,e.key.row);i>=0&&i<this.tileCoordRange&&n>=0&&n<this.tileCoordRange&&o.push({symbol:t,xTransformed:i,yTransformed:n});}const r=[],y=e.key.level<l.level?1:1<<e.key.level-l.level,a=this._tiles.get(e.id).symbols.get(i);if(a){const e=a.flat;for(const s of o){let l,o=!1;const t=s.xTransformed,i=s.yTransformed;l=null!=a.index?a.index.getCell(t,i):e;const n=s.symbol,f=n.hash;for(const e of l)if(f===e.hash&&Math.abs(t-e.xTile)<=y&&Math.abs(i-e.yTile)<=y){const s=e.unique;n.unique=s,s.tileSymbols.push(n),o=!0;break}o||r.push(n);}}r.length>0&&t.set(i,r);}for(const s of e.childrenTiles)this._matchSymbols(s,l,t);}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsReferences,s=new Array(e.size);let l,o=0;for(const[t,i]of e){const e=new Array(i.size);l=0;for(const s of i)e[l++]=s;s[o]={styleLayerUID:t,uniqueSymbols:e},o++;}return s}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
const c=.5,n=1e-6;class _ extends n$5{constructor(t,e$1){super(),this.styleRepository=t,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._completed=!1,this._symbolRepository=new i(4096,e$1,(()=>new s$1)),this._symbolDeclutterer=new e(e$1,this._symbolRepository,((t,e,i)=>new l$2(t,e,i,this.styleRepository,this._zoom,this._viewState.rotation)),((t,e)=>{t.allSymbolsFadingOut=!0,t.lastOpacityUpdate=e,i$3(t,e,!0),t.decluttered=!0,t.requestRender();}),((t,e)=>this.styleRepository.getStyleLayerByUID(t.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(e.styleLayerUID).z),(t=>{const e=this.styleRepository.getStyleLayerByUID(t);if(this._zoom+n<e.minzoom||this._zoom-n>=e.maxzoom)return !1;const i=e.getLayoutProperty("visibility");return !i||i.getValue()!==i$4.NONE}));}addTile(t){t.decluttered=!1,this._tileToHandle.set(t,t.on("symbols-changed",(()=>{this._symbolRepository.add(t),this.restartDeclutter();}))),this._symbolRepository.add(t),this.restartDeclutter();}removeTile(t){const e=this._tileToHandle.get(t);e&&(this._symbolRepository.removeTile(t),this.restartDeclutter(),e.remove(),this._tileToHandle.delete(t));}update(t,e){return this._zoom=t,this._viewState={scale:e.scale,rotation:e.rotation,center:[e.center[0],e.center[1]],size:[e.size[0],e.size[1]]},this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable();}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach((t=>t.remove())),this._tileToHandle.clear();}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(t){this._symbolRepository.deleteStyleLayers(t);}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(c$3),this._completed&&this._scheduleNotifyStable());}_scheduleNotifyStable(){null!=this._stableNotificationHandle&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout((()=>{this._stableNotificationHandle=null,this.emit("fade-complete");}),(1+c)*e$7);}_notifyUnstable(){null!=this._stableNotificationHandle&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this.emit("fade-start");}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
class t$1 extends r$4{_createTransforms(){return {dvs:e$8(),tileMat3:e$8()}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
const y=1e-6;function p$1(e,t){if(e){const s=e.getLayoutProperty("visibility");if(!s||s.getValue()!==i$4.NONE&&(void 0===e.minzoom||e.minzoom<t+y)&&(void 0===e.maxzoom||e.maxzoom>=t-y))return !0}return !1}class m extends i$5{constructor(e){super(e),this._backgroundTiles=[],this._pointToCallbacks=new Map;}destroy(){this.removeAllChildren(),this._spriteMosaic?.dispose(),this._spriteMosaic=null,this._glyphMosaic?.dispose(),this._glyphMosaic=null,null!=this._symbolFader&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear();}setStyleResources(e,t,r){if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=r,null==this._symbolFader){const e=new _(this._styleRepository,this.children);e.on("fade-start",(()=>{this.emit("fade-start"),this.requestRender();})),e.on("fade-complete",(()=>{this.emit("fade-complete"),this.requestRender();})),this._symbolFader=e;}this._symbolFader.styleRepository=r;}setSpriteMosaic(e){this._spriteMosaic?.dispose(),this._spriteMosaic=e;}deleteStyleLayers(e){null!=this._symbolFader&&this._symbolFader.deleteStyleLayers(e);}async hitTest(t){const s=C();return this._pointToCallbacks.set(t,s),this.requestRender(),s.promise}enterTileInvalidation(){for(const e of this.children)e.invalidating=!0;}createRenderParams(e){return {...super.createRenderParams(e),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(e){!this.visible||e.drawPhase!==T$1.MAP&&e.drawPhase!==T$1.DEBUG||void 0===this._spriteMosaic||super.doRender(e);}addChild(e){return super.addChild(e),null!=this._symbolFader?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}removeChild(e){return null!=this._symbolFader&&this._symbolFader.removeTile(e),this.requestRender(),super.removeChild(e)}renderChildren(e){const{drawPhase:t}=e;if(t!==T$1.DEBUG){if(this._doRender(e),this._pointToCallbacks.size>0){e.drawPhase=T$1.HITTEST;const s=e.painter.effects.hittestVTL;s.bind(e),this._doRender(e),s.draw(e,this._pointToCallbacks),s.unbind(e),e.drawPhase=t;}}else super.renderChildren(e);}removeAllChildren(){for(let e=0;e<this.children.length;e++){const t=this.children[e];null!=this._symbolFader&&this._symbolFader.removeTile(t),t.dispose();}super.removeAllChildren();}getStencilTarget(){return this.children.filter((e=>e.neededForCoverage&&e.hasData()))}restartDeclutter(){null!=this._symbolFader&&this._symbolFader.restartDeclutter();}_doRender(e){const{context:t}=e,s=this._styleRepository;if(!s)return;const r=s.layers;let i=!0;e.drawPhase===T$1.HITTEST&&(i=!1),s.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,s.backgroundBucketIds)),super.renderChildren(e),e.drawPhase===T$1.MAP&&this._fade(e.displayLevel,e.state);const o=this.children.filter((e=>e.visible&&e.hasData()));if(!o||0===o.length)return t.bindVAO(),t.setStencilTestEnabled(!0),void t.setBlendingEnabled(!0);for(const l of o)l.triangleCount=0;t.setStencilWriteMask(0),t.setColorMask(!0,!0,!0,!0),t.setStencilOp(O.KEEP,O.KEEP,O.REPLACE),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(!0),t.setDepthFunction(I.LEQUAL),t.setClearDepth(1),t.clear(t.gl.DEPTH_BUFFER_BIT),e.renderPass="opaque";for(let l=r.length-1;l>=0;l--)this._renderStyleLayer(r[l],e,o);t.setDepthWriteEnabled(!1),t.setBlendingEnabled(i),t.setBlendFunctionSeparate(R.ONE,R.ONE_MINUS_SRC_ALPHA,R.ONE,R.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let l=0;l<r.length;l++)this._renderStyleLayer(r[l],e,o);t.bindVAO(),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0);}_fade(e,t){null!=this._symbolFader&&(this._symbolFader.update(e,t)||this.requestRender());}_renderStyleLayer(e,t,s){const{painter:l,renderPass:o}=t;if(void 0===e)return;const n=e.getLayoutProperty("visibility");if(n&&n.getValue()===i$4.NONE)return;let a;switch(e.type){case a$2.BACKGROUND:return;case a$2.FILL:if("opaque"!==o&&"translucent"!==t.renderPass)return;a="vtlFill";break;case a$2.LINE:if("translucent"!==o)return;a="vtlLine";break;case a$2.CIRCLE:if("translucent"!==o)return;a="vtlCircle";break;case a$2.SYMBOL:if("translucent"!==o)return;a="vtlSymbol";}if(s=e.type===a$2.SYMBOL?s.filter((e=>e.decluttered)):s.filter((e=>e.neededForCoverage)),"vtlSymbol"!==a){const r=t.displayLevel;if(0===s.length||void 0!==e.minzoom&&e.minzoom>=r+y||void 0!==e.maxzoom&&e.maxzoom<r-y)return}const d=e.uid;t.styleLayerUID=d,t.styleLayer=e;for(const r of s)if(r.layerData.has(d)){l.renderObjects(t,s,a);break}}_renderBackgroundLayers(e,s){const{context:r,displayLevel:n,painter:u,state:y}=e,m=this._styleRepository;let f=!1;for(const t of s){if(m.getLayerById(t).type===a$2.BACKGROUND&&p$1(m.getLayerById(t),n)){f=!0;break}}if(!f)return;const _=this._tileInfoView.getTileCoverage(e.state,0,!0,"smallest"),{spans:b,lodInfo:g}=_,{level:T}=g,E=i$6(),C=[];if(this._renderPasses){const t=this._renderPasses[0];null!=this._clippingInfos&&(t.brushes[0].prepareState(e),t.brushes[0].drawMany(e,this._clippingInfos));}const L=this._backgroundTiles;let v,R=0;for(const{row:i,colFrom:l,colTo:a}of b)for(let e=l;e<=a;e++){if(R<L.length)v=L[R],v.key.set(T,i,g.normalizeCol(e),g.getWorldForColumn(e)),this._tileInfoView.getTileBounds(E,v.key,!1),v.x=E[0],v.y=E[3],v.resolution=this._tileInfoView.getTileResolution(T);else {const s=new e$5(T,i,g.normalizeCol(e),g.getWorldForColumn(e)),r=this._tileInfoView.getTileBounds(i$6(),s),l=this._tileInfoView.getTileResolution(T);v=new t$1(s,l,r[0],r[3],512,512,4096,4096),L.push(v);}v.setTransform(y),C.push(v),R++;}r.setStencilWriteMask(0),r.setColorMask(!0,!0,!0,!0),r.setStencilOp(O.KEEP,O.KEEP,O.REPLACE),r.setStencilFunction(I.EQUAL,0,255);let S=!0;e.drawPhase===T$1.HITTEST&&(S=!1),r.setStencilTestEnabled(S);for(const t of s){const s=m.getLayerById(t);s.type===a$2.BACKGROUND&&p$1(s,n)&&(e.styleLayerUID=s.uid,e.styleLayer=s,u.renderObjects(e,C,"vtlBackground"));}l$6.pool.release(_);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
const u={geometry:[new t$8("a_PositionAndFlags",3,C$1.SHORT,0,6)]},p=new Map;p.set("a_PositionAndFlags",0);const g={vsPath:"debug/overlay",fsPath:"debug/overlay",attributes:p};class l extends i$7{constructor(e){super(),this._conf=e;}static makeFlags(e,t){return e|t<<2}_createTransforms(){return {dvs:e$8()}}doRender(e){this._updateTransforms(e),this._ensureResources(e);const{context:t}=e;t.useProgram(this._program),this._program.setUniformMatrix3fv("u_dvsMat3",this.transforms.dvs),this._program.setUniform4fv("u_colors",this._conf.getColors(e)),this._program.setUniform1fv("u_opacities",this._conf.getOpacities(e));const{vertexData:r,indexData:s}=this._conf.getMesh(e);this._vertexBuffer.setData(r),this._indexBuffer.setData(s),t.bindVAO(this._vertexArray),t.setBlendingEnabled(!0),t.setBlendFunction(R.ONE,R.ONE_MINUS_SRC_ALPHA),t.setDepthTestEnabled(!1),t.setStencilTestEnabled(!1),t.setColorMask(!0,!0,!0,!0),t.drawElements(E$1.TRIANGLES,s.length,C$1.UNSIGNED_INT,0);}onDetach(){this._vertexArray=t$6(this._vertexArray);}_updateTransforms(e){r$5(this.transforms.dvs),M(this.transforms.dvs,this.transforms.dvs,[-1,1]),f$3(this.transforms.dvs,this.transforms.dvs,[2/e.state.size[0],-2/e.state.size[1],1]);}_ensureResources(e){const{context:t}=e;this._program||(this._program=e.painter.materialManager.getProgram(g)),this._vertexBuffer||(this._vertexBuffer=c$2.createVertex(t,F.STREAM_DRAW)),this._indexBuffer||(this._indexBuffer=c$2.createIndex(t,F.STREAM_DRAW)),this._vertexArray||(this._vertexArray=new u$2(t,p,u,{geometry:this._vertexBuffer},this._indexBuffer));}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
class t extends h$3{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={};}getTileParentId(e){const l=e$5.pool.acquire(e),t=0===l.level?null:e$5.getId(l.level-1,l.row>>1,l.col>>1,l.world);return e$5.pool.release(l),t}getTileCoverage(e,l,s=!0,t){const o=super.getTileCoverage(e,l,s,t);if(!o)return o;const i=1<<o.lodInfo.level;return o.spans=o.spans.filter((e=>e.row>=0&&e.row<i)),o}scaleToLevel(e){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[e])return this._levelByScale[e];{const l=this._fullCacheLodInfos;if(e>l[0].scale)return l[0].level;let s,t;for(let o=0;o<l.length-1;o++)if(t=l[o+1],e>t.scale)return s=l[o],s.level+(s.scale-e)/(s.scale-t.scale);return l[l.length-1].level}}_initializeFullCacheLODs(l){let s;if(0===l[0].level)s=l.map((e=>({level:e.level,resolution:e.resolution,scale:e.scale})));else {const l=this.tileInfo.size[0],t=this.tileInfo.spatialReference;s=j$2.create({size:l,spatialReference:t}).lods.map((e=>({level:e.level,resolution:e.resolution,scale:e.scale})));}for(let e=0;e<s.length;e++)this._levelByScale[s[e].scale]=s[e].level;this._fullCacheLodInfos=s;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
let D=class extends(f$4(d$2)){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._collisionOverlay=null,this.fading=!1,this._getCollidersMesh=e=>{const{pixelRatio:t}=e.state;let i=0;const s=[],r=[];for(const a of this._vectorTileContainer.children)if(a.symbols)for(const[e,l$1]of a.symbols)for(const a of l$1)for(const e of a.colliders){const l$1=(e.xScreen+e.dxScreen)*t,n=(e.yScreen+e.dyScreen)*t,o=e.width*t,h=e.height*t,u=a.unique.parts[e.partIndex].targetOpacity>.5;if(!u&&"all"!==this.layer.showCollisionBoxes)continue;const c=3,y=1,p=3,d=0,_=u?2:0,f=u?3:0,g=l.makeFlags(_,f);s.push(l$1,n,g,l$1+o,n,g,l$1,n+h,g,l$1+o,n+h,g),r.push(i,i+1,i+2,i+1,i+3,i+2),i+=4;const m=u?c:y,C=u?p:d,T=l.makeFlags(m,C);s.push(l$1,n,T,l$1+o,n,T,l$1,n+1,T,l$1+o,n+1,T),r.push(i,i+1,i+2,i+1,i+3,i+2),i+=4,s.push(l$1,n+h-1,T,l$1+o,n+h-1,T,l$1,n+h,T,l$1+o,n+h,T),r.push(i,i+1,i+2,i+1,i+3,i+2),i+=4,s.push(l$1,n,T,l$1+1,n,T,l$1,n+h,T,l$1+1,n+h,T),r.push(i,i+1,i+2,i+1,i+3,i+2),i+=4,s.push(l$1+o-1,n,T,l$1+o,n,T,l$1+o-1,n+h,T,l$1+o,n+h,T),r.push(i,i+1,i+2,i+1,i+3,i+2),i+=4;}return {vertexData:new Int16Array(s),indexData:new Uint32Array(r)}},this._getCollidersColors=()=>[1,.5,0,1,1,0,0,1,0,1,.5,1,0,.5,0,1],this._getCollidersOpacities=()=>[.05,.01,.15,.2];}async hitTest(e,i){if(!this._tileHandlerPromise)return null;await this._tileHandlerPromise;const s=await this._vectorTileContainer.hitTest(i);if(!s||0===s.length)return null;const r=s[0]-1,a=this._styleRepository,l=a.getStyleLayerByUID(r);if(!l)return null;const n=a.getStyleLayerIndex(l.id);return [{type:"graphic",mapPoint:e,layer:this.layer,graphic:new h$4({attributes:{layerId:n,layerName:l.id,layerUID:r},layer:this.layer,sourceLayer:this.layer})}]}update(e){if(this._tileHandlerPromise&&this._isTileHandlerReady)return e.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=e.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=e.state,this._parseQueue.state=e.state,this._tileManager.update(e)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}attach(){const{style:e}=this.layer.currentStyleInfo;this._styleRepository=new l$8(e),this._tileInfoView=new t(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new m(this._tileInfoView),this._tileHandler=new h$1(this.layer,this._styleRepository,window.devicePixelRatio||1),this.container.addChild(this._vectorTileContainer),this._start(),this.addAttachHandles([this._vectorTileContainer.on("fade-start",(()=>{this.fading=!0,this.notifyChange("updating"),this.requestUpdate();})),this._vectorTileContainer.on("fade-complete",(()=>{this._collisionOverlay?.requestRender(),this.fading=!1,this.notifyChange("updating"),this.requestUpdate();})),l$9((()=>this.layer.showCollisionBoxes),(e=>{"none"!==e?this._collisionOverlay||(this._collisionOverlay=new l({getMesh:this._getCollidersMesh,getColors:this._getCollidersColors,getOpacities:this._getCollidersOpacities}),this.container.addChild(this._collisionOverlay)):this._collisionOverlay&&(this.container.removeChild(this._collisionOverlay),this._collisionOverlay=null),this.container.requestRender();}),h$5),this.layer.on("paint-change",(e=>{if(e.isDataDriven)this._styleChanges.push({type:I$1.PAINTER_CHANGED,data:e}),this.notifyChange("updating"),this.requestUpdate();else {const t=this._styleRepository,i=t.getLayerById(e.layer);if(!i)return;const s=i.type===a$2.SYMBOL;t.setPaintProperties(e.layer,e.paint),s&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender();}})),this.layer.on("layout-change",(e=>{const t=this._styleRepository,i=t.getLayerById(e.layer);if(!i)return;const s=a$3(i.layout,e.layout);if(null!=s){if(s$4(s,"visibility")&&1===Q(s))return t.setLayoutProperties(e.layer,e.layout),i.type===a$2.SYMBOL&&this._vectorTileContainer.restartDeclutter(),void this._vectorTileContainer.requestRender();this._styleChanges.push({type:I$1.LAYOUT_CHANGED,data:e}),this.notifyChange("updating"),this.requestUpdate();}})),this.layer.on("style-layer-visibility-change",(e=>{const t=this._styleRepository,i=t.getLayerById(e.layer);i&&(t.setStyleLayerVisibility(e.layer,e.visibility),i.type===a$2.SYMBOL&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender());})),this.layer.on("style-layer-change",(e=>{this._styleChanges.push({type:I$1.LAYER_CHANGED,data:e}),this.notifyChange("updating"),this.requestUpdate();})),this.layer.on("delete-style-layer",(e=>{this._styleChanges.push({type:I$1.LAYER_REMOVED,data:e}),this.notifyChange("updating"),this.requestUpdate();})),this.layer.on("load-style",(()=>this._loadStyle())),this.layer.on("spriteSource-change",(e=>{this._newSpriteSource=e.spriteSource,this._styleChanges.push({type:I$1.SPRITES_CHANGED,data:null});const t=this._styleRepository.layers;for(const i of t)switch(i.type){case a$2.SYMBOL:i.getLayoutProperty("icon-image")&&this._styleChanges.push({type:I$1.LAYOUT_CHANGED,data:{layer:i.id,layout:i.layout}});break;case a$2.LINE:i.getPaintProperty("line-pattern")&&this._styleChanges.push({type:I$1.PAINTER_CHANGED,data:{layer:i.id,paint:i.paint,isDataDriven:i.isPainterDataDriven()}});break;case a$2.FILL:i.getLayoutProperty("fill-pattern")&&this._styleChanges.push({type:I$1.PAINTER_CHANGED,data:{layer:i.id,paint:i.paint,isDataDriven:i.isPainterDataDriven()}});}this.notifyChange("updating"),this.requestUpdate();}))]);}detach(){this._stop(),this.container.removeAllChildren(),this._vectorTileContainer=l$a(this._vectorTileContainer),this._tileHandler=l$a(this._tileHandler);}moveStart(){this.requestUpdate();}viewChange(){this.requestUpdate();}moveEnd(){this._collisionOverlay&&this._vectorTileContainer.restartDeclutter(),this.requestUpdate();}supportsSpatialReference(e){return S(this.layer.tileInfo?.spatialReference,e)}canResume(){let e=super.canResume();const{currentStyleInfo:t}=this.layer;if(e&&t?.layerDefinition){const i=this.view.scale,{minScale:s,maxScale:r}=t.layerDefinition;t&&t.layerDefinition&&(s&&s<i&&(e=!1),r&&r>i&&(e=!1));}return e}isUpdating(){const e=this._vectorTileContainer.children;return !this._isTileHandlerReady||!this._fetchQueue||!this._parseQueue||this._fetchQueue.updating||this._parseQueue.updating||e.length>0&&e.some((e=>e.invalidating))||this.fading}acquireTile(e){const t=this._createVectorTile(e);return this._tileHandlerPromise?.then((()=>{this._fetchQueue.push(t.key).then((e=>this._parseQueue.push({key:t.key,data:e}))).then((e=>{t.once("attach",(()=>this.requestUpdate())),t.setData(e),this.requestUpdate(),this.notifyChange("updating");})).catch((e=>{this.notifyChange("updating"),d$1(e)||s$5.getLogger(this).error(e);}));})),t}releaseTile(e){const t=e.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate();}_start(){if(this._stop(),this._tileManager=new o$3({acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const e=new AbortController,t=this._tileHandler.start({signal:e.signal}).then((()=>{this._fetchQueue=new y$1({tileInfoView:this._tileInfoView,process:(e,t)=>this._getTileData(e,t),concurrency:15}),this._parseQueue=new y$1({tileInfoView:this._tileInfoView,process:(e,t)=>this._parseTileData(e,t),concurrency:8}),this.requestUpdate(),this._isTileHandlerReady=!0;}));this._tileHandler.spriteMosaic.then((e=>{this._vectorTileContainer.setStyleResources(e,this._tileHandler.glyphMosaic,this._styleRepository),this.requestUpdate();})),this._tileHandlerAbortController=e,this._tileHandlerPromise=t;}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const e=this._tileHandlerAbortController;e&&e.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue=l$a(this._fetchQueue),this._parseQueue=l$a(this._parseQueue),this._tileManager=l$a(this._tileManager),this._vectorTileContainer.removeAllChildren();}async _getTileData(e,t){const i=await this._tileHandler.fetchTileData(e,t);return this.notifyChange("updating"),i}async _parseTileData(e,t){return this._tileHandler.parseTileData(e,t)}async _applyStyleChanges(){this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._tileManager.clearCache();const e=this._styleChanges;try{await this._tileHandler.updateStyle(e);}catch(n){s$5.getLogger(this).error("error applying vector-tiles style update",n.message),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0;}const t=this._styleRepository,i=[];e.forEach((e=>{if(e.type!==I$1.LAYER_REMOVED)return;const s=e.data,r=t.getLayerById(s.layer);r&&i.push(r.uid);}));const r=[];let a;e.forEach((e=>{const i=e.type,s=e.data;switch(i){case I$1.PAINTER_CHANGED:t.setPaintProperties(s.layer,s.paint),a=s.layer;break;case I$1.LAYOUT_CHANGED:t.setLayoutProperties(s.layer,s.layout),a=s.layer;break;case I$1.LAYER_REMOVED:return void t.deleteStyleLayer(s.layer);case I$1.LAYER_CHANGED:t.setStyleLayer(s.layer,s.index),a=s.layer.id;break;case I$1.SPRITES_CHANGED:this._vectorTileContainer.setSpriteMosaic(this._tileHandler.setSpriteSource(this._newSpriteSource)),this._newSpriteSource=null,a=null;}const l=t.getLayerById(a);l&&r.push(l.uid);}));const l=this._vectorTileContainer.children;if(i.length>0){this._vectorTileContainer.deleteStyleLayers(i);for(const e of l)e.deleteLayerData(i);}if(this._fetchQueue.resume(),this._parseQueue.resume(),r.length>0){const e=[];for(const t of l){const i=this._fetchQueue.push(t.key).then((e=>this._parseQueue.push({key:t.key,data:e,styleLayerUIDs:r}))).then((e=>t.setData(e)));e.push(i);}await Promise.all(e);}this._styleChanges=[],this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate();}async _loadStyle(){const{style:e}=this.layer.currentStyleInfo,t=a$4(e);this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this.notifyChange("updating"),this._styleRepository=new l$8(t),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=new AbortController;const{signal:s}=this._tileHandlerAbortController;try{this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,t),await this._tileHandlerPromise;}catch(l){if(!d$1(l))throw l}if(s.aborted)return this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),void this.requestUpdate();const r=await this._tileHandler.spriteMosaic;this._vectorTileContainer.setStyleResources(r,this._tileHandler.glyphMosaic,this._styleRepository),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate();}_createVectorTile(e){const t=this._tileInfoView.getTileBounds(i$6(),e),i=this._tileInfoView.getTileResolution(e.level);return new d(e,i,t[0],t[3],512,512,this._styleRepository)}};function Q(e){if(null==e)return 0;switch(e.type){case"partial":return Object.keys(e.diff).length;case"complete":return Math.max(Object.keys(e.oldValue).length,Object.keys(e.newValue).length);case"collection":return Object.keys(e.added).length+Object.keys(e.changed).length+Object.keys(e.removed).length}}e$9([y$2()],D.prototype,"_fetchQueue",void 0),e$9([y$2()],D.prototype,"_parseQueue",void 0),e$9([y$2()],D.prototype,"_isTileHandlerReady",void 0),e$9([y$2()],D.prototype,"fading",void 0),D=e$9([a$5("esri.views.2d.layers.VectorTileLayerView2D")],D);const L=D;

export default L;

//# sourceMappingURL=VectorTileLayerView2D-9db6a7c1.js.map