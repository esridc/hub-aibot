import { ao as v, bP as n$3, cV as l$1, eO as v$1, a1 as e$1, a2 as y, eP as n$4, bW as p$1, cs as M, aE as f$1, ct as c, a3 as a$4, cB as h, eQ as i$2, eR as o$1, eS as r$2, cQ as f$2, cM as b, eT as s$2, eU as i$3, O as j, a0 as m$3, cp as k, dM as a$5, f as s$3, cL as V$1, aB as R$1, eV as e$2, eW as y$1, dY as r$3, ca as H, e as has, eX as F, dH as i$4, d3 as j$1 } from './hub-compass-map-68308039.js';
import { i as i$1, r as r$4 } from './scaleUtils-e5a7b7c7.js';
import { n as n$2 } from './floorFilterUtils-29b268fd.js';
import { n as n$1 } from './sublayerUtils-101a4ab2.js';
import { n as n$5, p as p$2 } from './popupUtils-914b2733.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
function t(t,e){return e?"xoffset"in e&&e.xoffset?Math.max(t,Math.abs(e.xoffset)):"yoffset"in e&&e.yoffset?Math.max(t,Math.abs(e.yoffset||0)):t:t}function e(t){let e=0,n=0;for(let r=0;r<t.length;r++){const s=t[r].size;"number"==typeof s&&(e+=s,n++);}return e/n}function n(t,n){return "number"==typeof t?t:t&&t.stops&&t.stops.length?e(t.stops):n}function r$1(t,e){if(!e)return t;const r=e.filter((t=>"size"===t.type)).map((e=>{const{maxSize:r,minSize:s}=e;return (n(r,t)+n(s,t))/2}));let s=0;const o=r.length;if(0===o)return t;for(let n=0;n<o;n++)s+=r[n];const f=Math.floor(s/o);return Math.max(f,t)}function s$1(e){const n=e&&e.renderer,s="touch"===(e&&e.event&&e.event.pointerType)?9:6;if(!n)return s;const o="visualVariables"in n?r$1(s,n.visualVariables):s;if("simple"===n.type)return t(o,n.symbol);if("unique-value"===n.type){let e=o;return n.uniqueValueInfos?.forEach((n=>{e=t(e,n.symbol);})),e}if("class-breaks"===n.type){let e=o;return n.classBreakInfos.forEach((n=>{e=t(e,n.symbol);})),e}return "dot-density"===n.type||n.type,o}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
const s=e=>e.spatialReference.wkid||JSON.stringify(e.spatialReference);function l(e,t){const{dpi:i,gdbVersion:n,geometry:l,geometryPrecision:a,height:f,layerOption:p,mapExtent:m,maxAllowableOffset:y,returnFieldName:u,returnGeometry:c,returnUnformattedValues:d,returnZ:g,spatialReference:x,timeExtent:b,tolerance:h,width:E}=e.toJSON(),{dynamicLayers:O,layerDefs:S,layerIds:N}=o(e),j=t&&null!=t.geometry?t.geometry:null,J={geometryPrecision:a,maxAllowableOffset:y,returnFieldName:u,returnGeometry:c,returnUnformattedValues:d,returnZ:g,tolerance:h},R=j&&j.toJSON()||l;if(J.imageDisplay=`${E},${f},${i}`,n&&(J.gdbVersion=n),R&&(delete R.spatialReference,J.geometry=JSON.stringify(R),J.geometryType=v(R)),x?J.sr=x.wkid||JSON.stringify(x):R&&R.spatialReference?J.sr=s(R):m&&m.spatialReference&&(J.sr=s(m)),J.time=b?[b.start,b.end].join(","):null,m){const{xmin:e,ymin:r,xmax:t,ymax:i}=m;J.mapExtent=`${e},${r},${t},${i}`;}return S&&(J.layerDefs=S),O&&!S&&(J.dynamicLayers=O),J.layers="popup"===p?"visible":p,N&&!O&&(J.layers+=`:${N.join(",")}`),J}function o(e){const{mapExtent:r,floors:s,width:l,sublayers:o,layerIds:f,layerOption:p,gdbVersion:m}=e,y=o?.find((e=>null!=e.layer))?.layer?.serviceSublayers,u="popup"===p,c={},d=i$1({extent:r,width:l,spatialReference:r?.spatialReference}),g=[],x=e=>{const r=0===d,t=0===e.minScale||d<=e.minScale,i=0===e.maxScale||d>=e.maxScale;if(e.visible&&(r||t&&i))if(e.sublayers)e.sublayers.forEach(x);else {if(!1===f?.includes(e.id)||u&&(!e.popupTemplate||!e.popupEnabled))return;g.unshift(e);}};if(o?.forEach(x),o&&!g.length)c.layerIds=[];else {const e=n$1(g,y,m),r=g.map((e=>{const r=n$2(s,e);return e.toExportImageJSON(r)}));if(e)c.dynamicLayers=JSON.stringify(r);else {if(o){let e=g.map((({id:e})=>e));f&&(e=e.filter((e=>f.includes(e)))),c.layerIds=e;}else f?.length&&(c.layerIds=f);const e=a$3(s,g);if(null!=e&&e.length){const r={};for(const t of e)t.definitionExpression&&(r[t.id]=t.definitionExpression);Object.keys(r).length&&(c.layerDefs=JSON.stringify(r));}}}return c}function a$3(r,t){const n=!!r?.length,s=t.filter((e=>null!=e.definitionExpression||n&&null!=e.floorInfo));return s.length?s.map((t=>{const n=n$2(r,t),s=n$3(n,t.definitionExpression);return {id:t.id,definitionExpression:s??void 0}})):null}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
var m$2;let a$2=m$2=class extends l$1{static from(t){return v$1(m$2,t)}constructor(t){super(t),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400;}};e$1([y({type:Number,json:{write:!0}})],a$2.prototype,"dpi",void 0),e$1([y()],a$2.prototype,"floors",void 0),e$1([y({type:String,json:{write:!0}})],a$2.prototype,"gdbVersion",void 0),e$1([y({types:n$4,json:{read:p$1,write:!0}})],a$2.prototype,"geometry",void 0),e$1([y({type:Number,json:{write:!0}})],a$2.prototype,"geometryPrecision",void 0),e$1([y({type:Number,json:{write:!0}})],a$2.prototype,"height",void 0),e$1([y({type:[Number],json:{write:!0}})],a$2.prototype,"layerIds",void 0),e$1([y({type:["top","visible","all","popup"],json:{write:!0}})],a$2.prototype,"layerOption",void 0),e$1([y({type:M,json:{write:!0}})],a$2.prototype,"mapExtent",void 0),e$1([y({type:Number,json:{write:!0}})],a$2.prototype,"maxAllowableOffset",void 0),e$1([y({type:Boolean,json:{write:!0}})],a$2.prototype,"returnFieldName",void 0),e$1([y({type:Boolean,json:{write:!0}})],a$2.prototype,"returnGeometry",void 0),e$1([y({type:Boolean,json:{write:!0}})],a$2.prototype,"returnM",void 0),e$1([y({type:Boolean,json:{write:!0}})],a$2.prototype,"returnUnformattedValues",void 0),e$1([y({type:Boolean,json:{write:!0}})],a$2.prototype,"returnZ",void 0),e$1([y({type:f$1,json:{write:!0}})],a$2.prototype,"spatialReference",void 0),e$1([y()],a$2.prototype,"sublayers",void 0),e$1([y({type:c,json:{write:!0}})],a$2.prototype,"timeExtent",void 0),e$1([y({type:Number,json:{write:!0}})],a$2.prototype,"tolerance",void 0),e$1([y({type:Number,json:{write:!0}})],a$2.prototype,"width",void 0),a$2=m$2=e$1([a$4("esri.rest.support.IdentifyParameters")],a$2);const u$1=a$2;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
let u=class extends l$1{constructor(r){super(r),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null;}readFeature(r,t){return h.fromJSON({attributes:{...t.attributes},geometry:{...t.geometry}})}writeFeature(r,e){if(!r)return;const{attributes:t,geometry:o}=r;t&&(e.attributes={...t}),null!=o&&(e.geometry=o.toJSON(),e.geometryType=i$2.toJSON(o.type));}};e$1([y({type:String,json:{write:!0}})],u.prototype,"displayFieldName",void 0),e$1([y({type:h})],u.prototype,"feature",void 0),e$1([o$1("feature",["attributes","geometry"])],u.prototype,"readFeature",null),e$1([r$2("feature")],u.prototype,"writeFeature",null),e$1([y({type:Number,json:{write:!0}})],u.prototype,"layerId",void 0),e$1([y({type:String,json:{write:!0}})],u.prototype,"layerName",void 0),u=e$1([a$4("esri.rest.support.IdentifyResult")],u);const m$1=u;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
async function f(u,i,f){const c=(i=a$1(i)).geometry?[i.geometry]:[],l$1=f$2(u);return l$1.path+="/identify",b(c).then((e=>{const t=l(i,{geometry:e&&e[0]}),u=s$2({...l$1.query,f:"json",...t}),a=i$3(u,f);return j(l$1.path,a).then(m).then((r=>p(r,i.sublayers)))}))}function m(r){const e=r.data;return e.results=e.results||[],e.exceededTransferLimit=Boolean(e.exceededTransferLimit),e.results=e.results.map((r=>m$1.fromJSON(r))),e}function a$1(r){return r=u$1.from(r)}function p(r,e){if(!e?.length)return r;const t=new Map;function o(r){t.set(r.id,r),r.sublayers&&r.sublayers.forEach(o);}e.forEach(o);for(const s of r.results)s.feature.sourceLayer=t.get(s.layerId);return r}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
let P=null;function S(e,t){return "tile"===t.type||"map-image"===t.type}let U=class extends m$3{constructor(e){super(e),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=k((async e=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch((()=>{})));}));}initialize(){const e=e=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch((()=>{}))),this.updateHighlightedFeatures(this._highlightGeometriesResolution);};this.addHandles([a$5((()=>this.highlightGraphics),"change",(t=>e(t.added)),{onListenerAdd:t=>e(t)})]);}async fetchPopupFeatures(e,t){const{layerView:{layer:r,view:{scale:s}}}=this;if(!e)throw new s$3("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:r});const i=_(r.sublayers,s,t);if(!i.length)return [];const a=await A(r,i);if(!((r.capabilities?.operations?.supportsIdentify??!0)&&r.version>=10.5)&&!a)throw new s$3("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:r});return a?this._fetchPopupFeaturesUsingQueries(e,i,t):this._fetchPopupFeaturesUsingIdentify(e,i,t)}clearHighlights(){this.highlightGraphics?.removeAll();}highlight(e){const r=this.highlightGraphics;if(!r)return {remove(){}};let o=null;if(e instanceof h?o=[e]:V$1.isCollection(e)&&e.length>0?o=e.toArray():Array.isArray(e)&&e.length>0&&(o=e),o=o?.filter(R$1),!o||!o.length)return e$2();for(const t of o){const e=t.sourceLayer;null!=e&&"geometryType"in e&&"point"===e.geometryType&&(t.visible=!1);}return r.addMany(o),{remove:()=>{r.removeMany(o??[]);}}}async _updateHighlightedFeaturesSymbols(e){const{layerView:{view:t},highlightGraphics:r,highlightGraphicUpdated:s}=this;if(r&&s)for(const i of e){const e=i.sourceLayer&&"renderer"in i.sourceLayer&&i.sourceLayer.renderer;i.sourceLayer&&"geometryType"in i.sourceLayer&&"point"===i.sourceLayer.geometryType&&e&&"getSymbolAsync"in e&&e.getSymbolAsync(i).then((async o=>{o||=new y$1;let a=null;const n="visualVariables"in e?e.visualVariables?.find((e=>"size"===e.type)):void 0;n&&(P||(P=(await import('./hub-compass-map-68308039.js').then(function (n) { return n.mV; })).getSize),a=P(n,i,{view:t.type,scale:t.scale,shape:"simple-marker"===o.type?o.style:null})),a||="width"in o&&"height"in o&&null!=o.width&&null!=o.height?Math.max(o.width,o.height):"size"in o?o.size:16,r.includes(i)&&(i.symbol=new y$1({style:"square",size:a,xoffset:"xoffset"in o?o.xoffset:0,yoffset:"yoffset"in o?o.yoffset:0}),s(i,"symbol"),i.visible=!0);}));}}async _updateHighlightedFeaturesGeometries(e){const{layerView:{layer:t,view:r},highlightGraphics:s,highlightGraphicUpdated:i}=this;if(this._highlightGeometriesResolution=e,!i||!s?.length||!t.capabilities.operations.supportsQuery)return;const o=this._getTargetResolution(e),a=new Map;for(const c of s)if(!this._featuresResolutions.has(c)||this._featuresResolutions.get(c)>o){const e=c.sourceLayer;r$3(a,e,(()=>new Map)).set(c.getObjectId(),c);}const l=Array.from(a,(([e,t])=>{const s=e.createQuery();return s.objectIds=[...t.keys()],s.outFields=[e.objectIdField],s.returnGeometry=!0,s.maxAllowableOffset=o,s.outSpatialReference=r.spatialReference,e.queryFeatures(s)})),p=await Promise.all(l);if(!this.destroyed)for(const{features:n}of p)for(const e of n){const t=e.sourceLayer,r=a.get(t).get(e.getObjectId());r&&s.includes(r)&&(r.geometry=e.geometry,i(r,"geometry"),this._featuresResolutions.set(r,o));}}_getTargetResolution(e){const t=e*H(this.layerView.view.spatialReference),r=t/16;return r<=10?0:e/t*r}async _fetchPopupFeaturesUsingIdentify(e,t,r){const s=await this._createIdentifyParameters(e,t,r);if(null==s)return [];const{results:i}=await f(this.layerView.layer.parsedUrl,s);return i.map((e=>e.feature))}async _createIdentifyParameters(e,t,r){const{floors:s,layer:i,timeExtent:o,view:{spatialReference:a,scale:n}}=this.layerView,l=null!=r?r.event:null;if(!t.length)return null;await Promise.all(t.map((({sublayer:e})=>e.load().catch((()=>{})))));const p=Math.min(has("mapservice-popup-identify-max-tolerance"),i.allSublayers.reduce(((e,t)=>t.renderer?s$1({renderer:t.renderer,event:l}):e),2)),c=this.createFetchPopupFeaturesQueryGeometry(e,p),u=r$4(n,a),h=Math.round(c.width/u),y=new M({xmin:c.center.x-u*h,ymin:c.center.y-u*h,xmax:c.center.x+u*h,ymax:c.center.y+u*h,spatialReference:c.spatialReference});return new u$1({floors:s,gdbVersion:"gdbVersion"in i?i.gdbVersion:void 0,geometry:e,height:h,layerOption:"popup",mapExtent:y,returnGeometry:!0,spatialReference:a,sublayers:i.sublayers,timeExtent:o,tolerance:p,width:h})}async _fetchPopupFeaturesUsingQueries(e,t,r){const{layerView:{floors:i,timeExtent:o}}=this,a=null!=r?r.event:null,n=t.map((async({sublayer:t,popupTemplate:r})=>{if(await t.load().catch((()=>{})),t.capabilities&&!t.capabilities.operations.supportsQuery)return [];const s=t.createQuery(),n=s$1({renderer:t.renderer,event:a}),l=this.createFetchPopupFeaturesQueryGeometry(e,n),p=new Set,[c]=await Promise.all([n$5(t,r),t.renderer?.collectRequiredFields(p,t.fieldsIndex)]);F(p,t.fieldsIndex,c);const u=Array.from(p).sort();if(s.geometry=l,s.outFields=u,s.timeExtent=o,i){const e=i.clone(),r=n$2(e,t);null!=r&&(s.where=s.where?`(${s.where}) AND (${r})`:r);}const h=this._getTargetResolution(l.width/n),y=await R(r),m="point"===t.geometryType||y&&y.arcadeUtils.hasGeometryOperations(r);m||(s.maxAllowableOffset=h);let{features:f}=await t.queryFeatures(s);const b=m?0:h;f=await V(t,f);for(const e of f)this._featuresResolutions.set(e,b);return f}));return (await j$1(n)).reverse().reduce(((e,t)=>t.value?[...e,...t.value]:e),[]).filter(R$1)}};function _(e,t,r){const s=[],i=e=>{const o=0===e.minScale||t<=e.minScale,a=0===e.maxScale||t>=e.maxScale;if(e.visible&&o&&a)if(e.sublayers)e.sublayers.forEach(i);else if(e.popupEnabled){const t=p$2(e,{...r,defaultPopupTemplateEnabled:!1});null!=t&&s.unshift({sublayer:e,popupTemplate:t});}};return (e?.toArray()??[]).reverse().map(i),s}function R(e){return e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type))?i$4():Promise.resolve()}async function A(e,t){if(e.capabilities?.operations?.supportsQuery)return !0;try{return await Promise.any(t.map((({sublayer:e})=>e.load().then((()=>e.capabilities.operations.supportsQuery)))))}catch{return !1}}async function V(e,t){const r=e.renderer;return r&&"defaultSymbol"in r&&!r.defaultSymbol&&(t=r.valueExpression?await Promise.all(t.map((e=>r.getSymbolAsync(e).then((t=>t?e:null))))).then((e=>e.filter((e=>null!=e)))):t.filter((e=>null!=r.getSymbol(e)))),t}e$1([y({constructOnly:!0})],U.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),e$1([y({constructOnly:!0})],U.prototype,"layerView",void 0),e$1([y({constructOnly:!0})],U.prototype,"highlightGraphics",void 0),e$1([y({constructOnly:!0})],U.prototype,"highlightGraphicUpdated",void 0),e$1([y({constructOnly:!0})],U.prototype,"updatingHandles",void 0),U=e$1([a$4("esri.views.layers.support.MapService")],U);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
function r(t,r,i,a=new M){let o=0;if("2d"===i.type)o=r*(i.resolution??0);else if("3d"===i.type){const n=i.overlayPixelSizeInMapUnits(t),a=i.basemapSpatialReference;o=null==a||a.equals(i.spatialReference)?r*n:H(a)/H(i.spatialReference);}const s=t.x-o,l=t.y-o,m=t.x+o,p=t.y+o,{spatialReference:c}=i;return a.xmin=Math.min(s,m),a.ymin=Math.min(l,p),a.xmax=Math.max(s,m),a.ymax=Math.max(l,p),a.spatialReference=c,a}function i(e,n,i){const o=i.toMap(e);if(null==o)return !1;return r(o,s$1(),i,a).intersects(n)}const a=new M;

export { S, U, r };

//# sourceMappingURL=drapedUtils-80dcd858.js.map