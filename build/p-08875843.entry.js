import{r as t,h as e}from"./p-48186cc4.js";import{H as i,C as s,g as o,a,b as n,c as r,d as c,e as l,f as h}from"./p-be5561e0.js";import{s as d}from"./p-6c99a78d.js";
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.4.3
 */const p="calcite-mode-auto";const u="calcite-mode-dark";
/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.4.3
 */function b(){const{classList:t}=document.body;const e=window.matchMedia("(prefers-color-scheme: dark)").matches;const i=()=>t.contains(u)||t.contains(p)&&e?"dark":"light";const s=t=>document.body.dispatchEvent(new CustomEvent("calciteModeChange",{bubbles:true,detail:{mode:t}}));const o=t=>{a!==t&&s(t);a=t};let a=i();s(a);window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(t=>o(t.matches?"dark":"light")));new MutationObserver((()=>o(i()))).observe(document.body,{attributes:true,attributeFilter:["class"]})}function g(){const t=typeof window!=="undefined"&&typeof location!=="undefined"&&typeof document!=="undefined"&&window.location===location&&window.document===document;if(t){if(document.readyState==="interactive"){b()}else{document.addEventListener("DOMContentLoaded",(()=>b()),{once:true})}}}const f=g;f();const m={nearby:"https://ajturner-refactored-space-cod-6rr7x76f4gg6-8000.preview.app.github.dev/chat",text:"https://api.openai.com/v1/chat/completions",image:"https://api.openai.com/v1/images/generations"};function x(t,e){m[t]=e}async function w(t){const e=await fetch(m["nearby"]+"?"+new URLSearchParams({query:t}));const i=await e.text();return i}async function y(t,e="en",i,s){var o,a;const n={en:"gpt-3.5-turbo",es:"curie",fr:"davinci"};const r=n[e]||"gpt-3.5-turbo";const c=await fetch(m["text"],{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({model:r,messages:[{role:"system",content:i},{role:"user",content:t}],temperature:.4})});const l=await c.json();const h=(a=(o=l.choices[0])===null||o===void 0?void 0:o.message)===null||a===void 0?void 0:a.content;return h}async function v(t,e){var i;const s=await fetch(m["image"],{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({prompt:t})});const o=await s.json();const a=(i=o.data[0])===null||i===void 0?void 0:i.url;return a}const C=":host{display:block;position:fixed;bottom:20px;right:20px;}.fab{display:flex;justify-content:center;align-items:center;position:relative;color:white;font-size:28px;cursor:pointer;transition:width 0.3s;width:140px}.content{height:80vh}hub-chat-map{width:100%;height:100%}.fab:hover .fab-icon{background-color:gray;border-color:#0077c2}.fab .fab-icon{width:56px;background-color:#0077c2;width:56px;height:56px;border-radius:50%;box-shadow:0px 4px 10px rgba(0, 0, 0, 0.1)}.tooltip{position:absolute;top:-30px;left:0;right:0;margin:auto;display:none;background-color:rgba(0, 0, 0, 0.8);color:white;padding:4px 8px;border-radius:4px;font-size:12px;text-align:center;pointer-events:none}.fab:hover .tooltip{display:block}.chat-window.popup{position:fixed;bottom:90px;right:20px;width:350px;max-height:80vh;border-radius:10px;background-color:white;box-shadow:0px 4px 10px rgba(0, 0, 0, 0.1);overflow:hidden;height:600px}.chat-window{display:flex;height:100%;flex-direction:column}.messages{flex:1;display:flex;width:95%;padding:10px;overflow-y:scroll;flex-direction:column;gap:1rem}.chat-input{height:100px;width:100%;background-color:white;flex:0}.loading{display:flex;align-items:center;justify-content:center;height:40px}.dot{display:inline-block;width:8px;height:8px;margin:0 2px;background-color:#0077c2;border-radius:50%;animation:dot-pulse 1.2s infinite ease-in-out}@keyframes dot-pulse{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}.channel{cursor:pointer}.channel:hover{background-color:dodgerblue}.example-prompts{display:flex;justify-content:center;padding:10px}.example-prompts button{margin:0 5px;padding:8px 16px;border:none;border-radius:20px;background-color:#0077c2;color:white;font-size:14px;cursor:pointer}.example-prompts button:focus{outline:none}.example-prompts button:active{background-color:#005da8}.language-buttons{display:flex;justify-content:center;margin-top:10px}.language-buttons button{margin:0 5px;padding:5px 10px;border:none;border-radius:20px;background-color:#0077c2;color:white;font-size:14px;cursor:pointer}.language-buttons button:focus{outline:none}.language-buttons button:active{background-color:#005da8}#history{display:none;position:absolute;bottom:10px;left:10px;opacity:0.8;z-index:105}";const k=class{constructor(o){t(this,o);this.renderFeedback=e("div",{slot:"header-menu-actions"},e("calcite-action",{text:"Delete this Chat",icon:"x","text-enabled":true}));this.apikey="";this.modelUrl=null;this.model=i.Nearby;this.personality="You are writing for a government websites readable by 8th graders.";this.chatOpen=false;this.welcome=null;this.useAI=true;this.layout=s.Modal;this.language="en";this.messages=[];this.loading=false;this.currentChannel=null;this.availableChannels=[];this.showCreateChannel=false}async componentWillLoad(){if(!!this.modelUrl){x(this.model,this.modelUrl)}if(!!this.welcome){this.messages.push({author:"AI",text:this.welcome})}this.availableChannels=o();this.currentChannel=await a();await this.loadHistory(this.currentChannel.id)}async loadHistory(t=null){if(!t){t=this.currentChannel.id}console.debug("loadHistory",{channelId:t});const e=await n(t);console.debug("User signed in, getting chat history",{channelId:t,posts:e});this.messages=[];e.map((t=>{let e=t.creator!==d.user.username?t.creator:"user";if(t.body.match(/^AI:/)){e="hub";t.body=t.body.replace(/^AI: "/,"");t.body=t.body.replace(/"$/,"");t.body=t.body.replace(/[\\\/]/g,"")}this.messages.push({author:e,text:t.body,postId:t.id})}))}toggleChat(){this.chatOpen=!this.chatOpen}async sendMessage(t){const e=t.detail;const i=await r(this.currentChannel.id,e.text);e.postId=i.id;console.debug("added to chat history",{message:e,post:i});if(this.useAI){await this.queryAI(e,i)}}async queryAI(t,e){this.messages=[...this.messages,t];this.loading=true;let s="";console.debug("calling model",[this.model,t]);switch(this.model){case i.Nearby:s=await w(t.text);break;case i.Text:s=await y(t.text,this.language,this.personality,this.apikey);break;case i.Image:s=await v(t.text,this.apikey);break}const o=await r(this.currentChannel.id,`AI: ${s}`,e.id);this.hubCompassHistoryEl.history.push({type:"map",data:{}});console.debug("added to chat history",{message:t,aiPost:o});this.messages=[...this.messages,{author:c.hub,text:s,postId:o.id}];this.loading=false}async viewChat(){console.debug("viewChat")}async setupChat(){console.debug("setupChat")}render(){return e("div",null,this.renderChatWindow(this.chatOpen),this.renderChatFAB())}scrollToLastMessage(){this.messagesEl.scrollTo({top:this.messagesEl.scrollHeight,behavior:"smooth"})}componentDidRender(){this.scrollToLastMessage()}componentDidUpdate(){this.scrollToLastMessage()}renderChatFAB(){return e("div",{class:"fab",onClick:()=>this.toggleChat()},e("span",{class:"tooltip"},"Open Hub Compass"),e("calcite-icon",{class:"fab-icon",icon:"explore","text-label":"Open Hub Compass"}))}renderChatWindow(t=false){const e=this.renderChatBody();if(this.layout===s.Modal){return this.renderChatModal(t,e)}else if(t){return e}return null}renderChatBody(){return e("div",{class:`chat-window ${this.layout}`},e("div",{class:"messages",ref:t=>this.messagesEl=t},this.messages.map((t=>e("hub-chat-response",{class:`message author-${t.author}`,message:t}))),this.showCreateChannel?this.renderCreateChannel():null,this.loading?this.renderLoading():null),e("hub-chat-input",{class:"chat-input",disabled:this.loading}))}async createChannel(){console.debug("Create Channel",{groupId:this.currentChannel.id});const t=await l(this.currentChannel);this.currentChannel=t;this.showCreateChannel=false;this.loading=false}renderCreateChannel(){return[e("em",null,"There is not yet a Discussion channel for this group"),e("calcite-button",{onClick:()=>this.createChannel.call(this)},"Create a new Channel")]}renderChatModal(t,i){return e("calcite-modal",{fullscreen:true,open:t,"aria-labelledby":"modal-title",id:"example-modal"},e("div",{slot:"header",id:"modal-title"},"AI Chat"),e("div",{class:"content",slot:"content"},this.renderShell(i)))}renderShell(t){return e("calcite-shell",null,e("calcite-shell-panel",{ref:t=>this.shellPanelEl=t,collapsed:true,slot:"panel-start",position:"start",id:"shell-panel-start"},e("calcite-action-bar",{slot:"action-bar"},e("calcite-action",{onClick:()=>{this.shellPanelEl.collapsed=!this.shellPanelEl.collapsed;this.actionMapEl.active=!this.shellPanelEl.collapsed},active:true,text:"Channels",icon:"speech-bubble",indicator:true})),e("calcite-panel",{heading:"Channels",id:"panel-start"},this.availableChannels.map((t=>this.renderHistorySelect(t))))),e("calcite-panel",{heading:`Channel: ${this.currentChannel.name||this.currentChannel["title"]}`},t),e("calcite-panel",{heading:"Map",slot:"panel-end"},e("hub-chat-map",{longitude:-77,latitude:38.9}),e("hub-compass-history",{id:"history",ref:t=>this.hubCompassHistoryEl=t})))}async selectChannel(t){this.currentChannel=t;console.debug("selectChannel",t);const e=await h(t.id);if(!!e){this.currentChannel=e;this.loading=false;this.showCreateChannel=false;await this.loadHistory(this.currentChannel.id)}else{this.messages=[];this.loading=true;this.showCreateChannel=true}}renderHistorySelect(t=null,i=false){return e("calcite-block",{class:"channel",heading:t.title,onClick:e=>this.selectChannel(t)},e("calcite-icon",{scale:"s",slot:"icon",icon:i?"check-circle":""}),this.renderFeedback)}renderLoading(){return e("div",{class:"loading"},e("div",{class:"dot"}),e("div",{class:"dot"}),e("div",{class:"dot"}))}};k.style=C;export{k as hub_aibot};
//# sourceMappingURL=p-08875843.entry.js.map